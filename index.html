<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íƒë°° ë°°ì†¡ ê²Œì„</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;-webkit-tap-highlight-color:transparent}
        html,body{width:100%;overflow-x:hidden;background:#f0f2f5}
        body{min-height:100vh;min-height:100dvh}
        .screen{display:none;flex-direction:column;min-height:100vh;min-height:100dvh}
        .screen.active{display:flex}
        .btn{padding:14px 24px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;-webkit-appearance:none;appearance:none}
        .btn:active{opacity:.85;transform:scale(.97)}
        .btn-primary{background:#667eea;color:#fff}
        input[type=text]{width:100%;padding:14px 16px;border:2px solid #e8e8e8;border-radius:12px;font-size:16px;outline:none;-webkit-appearance:none;appearance:none;background:#fff}
        input[type=text]:focus{border-color:#667eea}
        .back-link{color:rgba(255,255,255,.8);text-align:center;padding:16px;font-size:14px;cursor:pointer}
        .back-link:active{color:#fff}
        .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}

        /* ì—­í• ì„ íƒ */
        #roleSelect{justify-content:center;align-items:center;padding:24px;gap:20px}
        #roleSelect h1{color:#fff;font-size:28px;text-align:center}
        #roleSelect>p{color:rgba(255,255,255,.8);font-size:15px}
        .role-cards{display:flex;gap:14px;width:100%;max-width:440px}
        .role-card{flex:1;background:#fff;border-radius:20px;padding:28px 14px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.12);cursor:pointer}
        .role-card:active{transform:scale(.97)}
        .role-card .icon{font-size:48px;margin-bottom:10px}
        .role-card h2{font-size:17px;color:#333;margin-bottom:4px}
        .role-card p{font-size:12px;color:#999}
        .online-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#43a047;margin-right:4px;animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
        .online-info{font-size:12px;color:rgba(255,255,255,.7);margin-top:-8px}

        /* ë¡œê·¸ì¸ */
        #loginScreen{justify-content:center;align-items:center;padding:24px}
        .login-box{background:#fff;border-radius:20px;padding:36px 24px;width:100%;max-width:400px;text-align:center;box-shadow:0 16px 50px rgba(0,0,0,.15)}
        .login-box h2{font-size:22px;color:#333;margin-bottom:4px}
        .login-box .sub{color:#aaa;font-size:13px;margin-bottom:24px}
        .login-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:15px;margin-bottom:10px;border:2px solid #eee;border-radius:14px;background:#fff;font-size:15px;font-weight:600;color:#333;cursor:pointer;-webkit-appearance:none}
        .login-btn:active{border-color:#667eea;background:#f5f6ff}
        .login-btn .li{font-size:20px;width:26px;text-align:center}

        /* íƒë°°ì‚¬ ì„ íƒ */
        #carrierSelect{justify-content:center;align-items:center;padding:24px}
        .carrier-box{background:#fff;border-radius:20px;padding:32px 20px;width:100%;max-width:420px;text-align:center;box-shadow:0 16px 50px rgba(0,0,0,.15)}
        .carrier-box h2{font-size:20px;color:#333;margin-bottom:20px}
        .carrier-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .carrier-btn{padding:18px 8px;border:2px solid #eee;border-radius:14px;background:#fff;font-size:14px;font-weight:700;color:#333;cursor:pointer;-webkit-appearance:none}
        .carrier-btn:active{border-color:#667eea;background:#f5f6ff}
        .carrier-btn .ci{font-size:26px;display:block;margin-bottom:4px}

        /* ì§ì› ë©”ì¸ */
        #staffMain{background:#f0f2f5}
        .top-bar{background:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,.05);flex-shrink:0;position:sticky;top:0;z-index:50}
        .top-bar h2{font-size:15px;color:#333;display:flex;align-items:center;gap:6px}
        .badge{background:#667eea;color:#fff;padding:2px 10px;border-radius:20px;font-size:11px;font-weight:700}
        .btn-logout{background:#ff4757;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;-webkit-appearance:none}
        .tabs{display:flex;background:#fff;border-bottom:1px solid #eee;position:sticky;top:49px;z-index:49;flex-shrink:0}
        .tab{flex:1;padding:13px 0;text-align:center;font-size:14px;font-weight:700;color:#aaa;border:none;border-bottom:3px solid transparent;background:none;cursor:pointer;-webkit-appearance:none}
        .tab.on{color:#667eea;border-bottom-color:#667eea}
        .panel{display:none;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .panel.on{display:block}

        .list-wrap{padding:14px}
        .wb-card{background:#fff;border-radius:14px;padding:14px 16px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.04);border-left:4px solid #667eea;cursor:pointer}
        .wb-card:active{transform:scale(.98)}
        .wb-card .num{font-weight:700;font-size:15px;color:#333}
        .wb-card .meta{font-size:12px;color:#999;margin-top:2px}
        .wb-card .st{display:inline-block;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700;margin-top:6px}
        .s0{background:#fff3e0;color:#f57c00}.s1{background:#e3f2fd;color:#1976d2}
        .s2{background:#e8eaf6;color:#3f51b5}.s3{background:#e0f2f1;color:#00897b}
        .s4{background:#f3e5f5;color:#8e24aa}.s5{background:#fce4ec;color:#e91e63}
        .s6{background:#e8f5e9;color:#43a047}
        .empty-msg{text-align:center;padding:60px 20px;color:#ccc}
        .empty-msg .ei{font-size:48px;margin-bottom:8px}
        .empty-msg p{font-size:14px}

        .form-wrap{padding:16px}
        .card{background:#fff;border-radius:16px;padding:24px 18px;box-shadow:0 4px 16px rgba(0,0,0,.06)}
        .card h3{font-size:19px;color:#333;margin-bottom:4px}
        .card .desc{font-size:13px;color:#aaa;margin-bottom:18px}
        .row{display:flex;gap:10px}
        .row input{flex:1;min-width:0}
        .row .btn{flex-shrink:0}

        .d-head{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;padding-bottom:14px;margin-bottom:18px;border-bottom:2px solid #f0f0f0}
        .d-head h3{font-size:17px;color:#333}
        .btn-sm{background:#f0f2f5;color:#667eea;border:none;padding:8px 14px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;-webkit-appearance:none}
        .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:22px}
        .ig{background:#f8f9fa;padding:11px 14px;border-radius:10px}
        .ig.full{grid-column:1/-1}
        .ig label{display:block;font-size:11px;color:#aaa;font-weight:700;margin-bottom:2px}
        .ig span{font-size:13px;color:#333;font-weight:500;word-break:break-all}
        .steps-title{font-size:14px;color:#333;font-weight:700;margin-bottom:14px}
        .step{display:flex;gap:12px}
        .sl{display:flex;flex-direction:column;align-items:center}
        .dot{width:28px;height:28px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;flex-shrink:0;z-index:1}
        .dot.done{background:#43a047}.dot.now{background:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,.25)}
        .conn{width:3px;height:32px;background:#e0e0e0}.conn.done{background:#43a047}
        .sc{padding-top:2px;padding-bottom:18px}
        .sc .t{font-weight:700;font-size:13px;color:#333}
        .sc .tm{font-size:11px;color:#aaa;margin-top:1px}
        .sc .ds{font-size:12px;color:#777;margin-top:1px}
        .btn-next{width:100%;padding:15px;border:none;border-radius:14px;font-size:16px;font-weight:700;color:#fff;cursor:pointer;background:linear-gradient(135deg,#667eea,#764ba2);margin-top:14px;-webkit-appearance:none}
        .btn-next:active{opacity:.85;transform:scale(.98)}
        .btn-next:disabled{background:#ccc}
        .done-badge{background:#e8f5e9;color:#43a047;padding:14px;border-radius:12px;text-align:center;font-weight:700;font-size:15px;margin-top:14px}

        /* ê³ ê° */
        #customerMain{background:linear-gradient(180deg,#667eea 0%,#f0f2f5 30%)}
        .c-head{padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
        .c-head h2{color:#fff;font-size:17px}
        .c-head .btn-logout{background:rgba(255,255,255,.2)}
        .c-body{padding:10px 16px 30px;width:100%;max-width:600px;margin:0 auto}
        .search-card{background:#fff;border-radius:20px;padding:28px 18px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.1);margin-bottom:14px}
        .search-card h2{font-size:20px;color:#333;margin-bottom:4px}
        .search-card>p{font-size:13px;color:#aaa;margin-bottom:18px}
        .search-row{display:flex;gap:10px}
        .search-row input{flex:1;min-width:0}
        .search-row .btn{flex-shrink:0}
        .result-card{background:#fff;border-radius:20px;padding:22px 18px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
        .r-head{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;padding-bottom:12px;margin-bottom:14px;border-bottom:2px solid #f0f0f0}
        .r-head h3{font-size:15px;color:#333}
        .cur-st{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700}
        .no-res{text-align:center;padding:40px 16px;color:#aaa}
        .no-res .ni{font-size:48px;margin-bottom:8px}

        /* ì‹¤ì‹œê°„ ì•Œë¦¼ í† ìŠ¤íŠ¸ */
        .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;max-width:90%;text-align:center}
        .toast.show{opacity:1}

        /* ë¡œë”© */
        .loading{text-align:center;padding:40px;color:#999}
        .spinner{display:inline-block;width:28px;height:28px;border:3px solid #eee;border-top-color:#667eea;border-radius:50%;animation:spin .6s linear infinite;margin-bottom:8px}
        @keyframes spin{to{transform:rotate(360deg)}}

        @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .fade{animation:fadeUp .25s ease}
        @media(min-width:768px){#roleSelect h1{font-size:40px}.role-card{padding:36px 20px}.role-card .icon{font-size:60px}.role-card h2{font-size:20px}.info-grid{grid-template-columns:1fr 1fr}}
    </style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- ì—­í• ì„ íƒ -->
<div id="roleSelect" class="screen active gradient-bg">
    <h1>ğŸ“¦ íƒë°° ë°°ì†¡ ê²Œì„</h1>
    <p>ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</p>
    <div class="role-cards">
        <div class="role-card" onclick="go('staff')">
            <div class="icon">ğŸšš</div>
            <h2>íƒë°°ì‚¬ ì§ì›</h2>
            <p>íƒë°°ë¥¼ ì ‘ìˆ˜í•˜ê³  ë°°ì†¡í•´ìš”</p>
        </div>
        <div class="role-card" onclick="go('customer')">
            <div class="icon">ğŸ“±</div>
            <h2>ì¼ë°˜ ê³ ê°</h2>
            <p>ë‚´ íƒë°° ì–´ë””ìˆì§€?</p>
        </div>
    </div>
    <p class="online-info"><span class="online-dot"></span>ì‹¤ì‹œê°„ ë©€í‹°í”Œë ˆì´ ì§€ì›</p>
</div>

<!-- ë¡œê·¸ì¸ -->
<div id="loginScreen" class="screen gradient-bg">
    <div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:24px">
        <div class="login-box">
            <h2 id="lT">ë¡œê·¸ì¸</h2>
            <p class="sub" id="lS">ê°„í¸ ë¡œê·¸ì¸ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”</p>
            <button class="login-btn" onclick="login()"><span class="li">ğŸ’™</span>ì‚¼ì„±í˜ì´ë¡œ ë¡œê·¸ì¸</button>
            <button class="login-btn" onclick="login()"><span class="li">ğŸ’›</span>ì¹´ì¹´ì˜¤í˜ì´ë¡œ ë¡œê·¸ì¸</button>
            <button class="login-btn" onclick="login()"><span class="li">ğŸ</span>Appleë¡œ ë¡œê·¸ì¸</button>
            <button class="login-btn" onclick="login()"><span class="li">ğŸ”µ</span>Googleë¡œ ë¡œê·¸ì¸</button>
        </div>
    </div>
    <div class="back-link" onclick="showScr('roleSelect')">â† ì—­í•  ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</div>
</div>

<!-- íƒë°°ì‚¬ ì„ íƒ -->
<div id="carrierSelect" class="screen gradient-bg">
    <div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:24px">
        <div class="carrier-box">
            <h2>ğŸ¢ íƒë°°íšŒì‚¬ ì„ íƒ</h2>
            <div class="carrier-grid">
                <button class="carrier-btn" onclick="pickCarrier('CJëŒ€í•œí†µìš´')"><span class="ci">ğŸ“¦</span>CJëŒ€í•œí†µìš´</button>
                <button class="carrier-btn" onclick="pickCarrier('í•œì§„íƒë°°')"><span class="ci">ğŸš›</span>í•œì§„íƒë°°</button>
                <button class="carrier-btn" onclick="pickCarrier('ë¡¯ë°íƒë°°')"><span class="ci">ğŸšš</span>ë¡¯ë°íƒë°°</button>
                <button class="carrier-btn" onclick="pickCarrier('ë¡œì  íƒë°°')"><span class="ci">ğŸ“«</span>ë¡œì  íƒë°°</button>
                <button class="carrier-btn" onclick="pickCarrier('ìš°ì²´êµ­íƒë°°')"><span class="ci">ğŸ£</span>ìš°ì²´êµ­íƒë°°</button>
                <button class="carrier-btn" onclick="pickCarrier('ì¿ íŒ¡ë¡œì¼“')"><span class="ci">ğŸš€</span>ì¿ íŒ¡ë¡œì¼“</button>
            </div>
        </div>
    </div>
    <div class="back-link" onclick="showScr('loginScreen')">â† ë’¤ë¡œê°€ê¸°</div>
</div>

<!-- ì§ì› ë©”ì¸ -->
<div id="staffMain" class="screen">
    <div class="top-bar">
        <h2>ğŸ“¦ íƒë°°ê´€ë¦¬ <span class="badge" id="cBadge"></span></h2>
        <button class="btn-logout" onclick="showScr('roleSelect')">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div class="tabs">
        <button class="tab on" id="t1" onclick="tab(1)">ğŸ“‹ ëª©ë¡</button>
        <button class="tab" id="t2" onclick="tab(2)">ğŸ“ ì…ë ¥</button>
    </div>
    <div class="panel on" id="p1">
        <div class="list-wrap" id="wList">
            <div class="loading"><div class="spinner"></div><p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
        </div>
    </div>
    <div class="panel" id="p2">
        <div class="form-wrap" id="mainArea"></div>
    </div>
</div>

<!-- ê³ ê° ë©”ì¸ -->
<div id="customerMain" class="screen">
    <div class="c-head">
        <h2>ğŸ“¦ íƒë°° ì¡°íšŒ</h2>
        <button class="btn-logout" onclick="showScr('roleSelect')">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div class="c-body">
        <div class="search-card fade">
            <h2>ğŸ” ë°°ì†¡ ì¡°íšŒ</h2>
            <p>ìš´ì†¡ì¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <div class="search-row">
                <input type="text" id="tInput" placeholder="ìš´ì†¡ì¥ ë²ˆí˜¸" maxlength="15" inputmode="numeric" onkeypress="if(event.key==='Enter')track()">
                <button class="btn btn-primary" onclick="track()">ì¡°íšŒ</button>
            </div>
        </div>
        <div id="tResult"></div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ========== Firebase ì´ˆê¸°í™” ==========
const firebaseConfig = {
    apiKey: "AIzaSyASiZJwKTgR5eIEwnZ6NebiwpzB_PGw1WU",
    authDomain: "abcd-c0ead.firebaseapp.com",
    databaseURL: "https://abcd-c0ead-default-rtdb.firebaseio.com",
    projectId: "abcd-c0ead",
    storageBucket: "abcd-c0ead.firebasestorage.app",
    messagingSenderId: "1065808686638",
    appId: "1:1065808686638:web:e36f122d059a8d788b79bf"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const wbRef = db.ref('waybills');

// ========== ë°ì´í„° ==========
let role='', carrier='', wb={}, currentView='';

const ST=[
    {n:'ìƒí’ˆ ì ‘ìˆ˜',i:'ğŸ“‹',d:'íƒë°° ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'},
    {n:'ì§‘í•˜ ì™„ë£Œ',i:'ğŸ“¦',d:'ë¬¼ë¥˜ì„¼í„°ì—ì„œ ìƒí’ˆì„ ìˆ˜ê±°í–ˆìŠµë‹ˆë‹¤'},
    {n:'ì§€ì—­ ë¬¼ë¥˜ì„¼í„° ë„ì°©',i:'ğŸ­',d:'ì§€ì—­ ë¬¼ë¥˜ì„¼í„°ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤'},
    {n:'ë°°ì†¡ì§€ ë„ì°©',i:'ğŸ¬',d:'ë°°ì†¡ì§€ ê·¼ì²˜ ì„¼í„°ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤'},
    {n:'ë°°ì†¡ ì¶œë°œ',i:'ğŸšš',d:'ë°°ì†¡ ê¸°ì‚¬ë‹˜ì´ ì¶œë°œí–ˆìŠµë‹ˆë‹¤'},
    {n:'ë°°ì†¡ ì¤‘',i:'ğŸ“',d:'ê³ ê°ë‹˜ê»˜ ë°°ë‹¬ ì¤‘ì…ë‹ˆë‹¤'},
    {n:'ë°°ì†¡ ì™„ë£Œ',i:'âœ…',d:'ë°°ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'}
];
const ITEMS=['ìš´ë™í™”','ì¥ë‚œê° ë¡œë´‡','ê·¸ë¦¼ì±… ì„¸íŠ¸','ê³¼ì ì„ ë¬¼ì„¸íŠ¸','ë¸”ë¡ ì¥ë‚œê°','ì¸í˜•','í‹°ì…”ì¸ ','í…€ë¸”ëŸ¬','ì´ì–´í°','ì¿ í‚¤ ì„¸íŠ¸','ìƒ‰ì—°í•„ ì„¸íŠ¸','í¼ì¦','ë³´ë“œê²Œì„','ì¶•êµ¬ê³µ','ê°€ë°©','ëª¨ì'];
const NAMES=['ê¹€ë¯¼ì¤€','ì´ì„œì—°','ë°•ì§€í˜¸','ìµœìˆ˜ì•„','ì •ë„ìœ¤','ê°•í•˜ì€','ì¡°ì‹œìš°','ìœ¤ì§€ì•„','ì¥ì˜ˆì¤€','í•œì†Œìœ¨','ì„ê±´ìš°','ì˜¤ë‚˜ìœ¤'];
const CITY=['ì„œìš¸','ë¶€ì‚°','ëŒ€êµ¬','ì¸ì²œ','ê´‘ì£¼','ëŒ€ì „','ìš¸ì‚°','ìˆ˜ì›','ê³ ì–‘','ìš©ì¸','ì„±ë‚¨','ì²­ì£¼','ì²œì•ˆ'];
const ROAD=['í•œë¹›ë¡œ','í–‰ë³µê¸¸','ë¯¸ë˜ë¡œ','í‘¸ë¥¸ê¸¸','ë³„ë¹›ë¡œ','ê¿ˆë‚˜ë¬´ê¸¸','ì‚¬ë‘ë¡œ','í¬ë§ê¸¸','í–‡ì‚´ê¸¸'];

function pk(a){return a[Math.floor(Math.random()*a.length)]}
function rAddr(){return pk(CITY)+' '+pk(ROAD)+' '+Math.floor(Math.random()*200+1)+'ë²ˆê¸¸ '+Math.floor(Math.random()*50+1)+'í˜¸'}

// ========== í† ìŠ¤íŠ¸ ì•Œë¦¼ ==========
function toast(msg){
    const el=document.getElementById('toast');
    el.textContent=msg;
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'),2500);
}

// ========== í™”ë©´ ì „í™˜ ==========
function showScr(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// ========== ì‹¤ì‹œê°„ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ==========
wbRef.on('value', snap => {
    wb = snap.val() || {};
    renderList();
    // í˜„ì¬ ìƒì„¸ ë³´ê³ ìˆëŠ” ìš´ì†¡ì¥ì´ ìˆìœ¼ë©´ ìë™ ê°±ì‹ 
    if(currentView && wb[currentView]){
        openDetail(currentView, true);
    }
});

// ========== ì—­í• ì„ íƒ ==========
function go(r){
    role=r;
    document.getElementById('lT').textContent=r==='staff'?'íƒë°°ì‚¬ ì§ì› ë¡œê·¸ì¸':'ê³ ê° ë¡œê·¸ì¸';
    document.getElementById('lS').textContent=r==='staff'?'ì§ì› ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”':'íƒë°° ì¡°íšŒë¥¼ ìœ„í•´ ë¡œê·¸ì¸í•˜ì„¸ìš”';
    showScr('loginScreen');
}

// ë¡œê·¸ì¸
function login(){
    if(role==='staff') showScr('carrierSelect');
    else showScr('customerMain');
}

// íƒë°°ì‚¬
function pickCarrier(c){
    carrier=c;
    document.getElementById('cBadge').textContent=c;
    showScr('staffMain');
    renderList();
    showForm();
}

// íƒ­
function tab(n){
    document.getElementById('t1').classList.toggle('on',n===1);
    document.getElementById('t2').classList.toggle('on',n===2);
    document.getElementById('p1').classList.toggle('on',n===1);
    document.getElementById('p2').classList.toggle('on',n===2);
}

// ========== ëª©ë¡ ==========
function renderList(){
    const el=document.getElementById('wList');
    const keys=Object.keys(wb);
    if(!keys.length){
        el.innerHTML='<div class="empty-msg"><div class="ei">ğŸ“­</div><p>ë“±ë¡ëœ ìš´ì†¡ì¥ì´ ì—†ì–´ìš”<br><span style="font-size:12px;color:#ddd">ì…ë ¥ íƒ­ì—ì„œ ë“±ë¡í•´ì£¼ì„¸ìš”</span></p></div>';
        return;
    }
    el.innerHTML=keys.slice().reverse().map(k=>{
        const w=wb[k],s=w.cs;
        return `<div class="wb-card" onclick="openDetail('${k}')">
            <div class="num">${k}</div>
            <div class="meta">${w.item} Â· ${w.wt}</div>
            <span class="st s${s}">${ST[s].i} ${ST[s].n}</span>
        </div>`;
    }).join('');
}

// ========== ì…ë ¥í¼ ==========
function showForm(){
    currentView='';
    document.getElementById('mainArea').innerHTML=`
        <div class="card fade">
            <h3>ğŸ“ ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥</h3>
            <p class="desc">ìƒˆ íƒë°°ë¥¼ ë“±ë¡í•˜ë ¤ë©´ ìš´ì†¡ì¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <div class="row">
                <input type="text" id="wInput" placeholder="ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥" maxlength="15" inputmode="numeric" onkeypress="if(event.key==='Enter')reg()">
                <button class="btn btn-primary" onclick="reg()">ë“±ë¡</button>
            </div>
        </div>`;
}

// ========== ë“±ë¡ (Firebaseì— ì €ì¥) ==========
function reg(){
    const inp=document.getElementById('wInput');
    const num=inp.value.trim();
    if(!num){inp.style.borderColor='#ff4757';setTimeout(()=>inp.style.borderColor='#e8e8e8',800);return;}
    if(wb[num]){alert('ì´ë¯¸ ë“±ë¡ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤!');return;}

    const data={
        item:pk(ITEMS), wt:(Math.random()*9+0.5).toFixed(1)+'kg',
        from:pk(NAMES), fa:rAddr(),
        to:pk(NAMES), ta:rAddr(),
        cr:carrier, cs:0,
        times:{0:new Date().toLocaleString('ko-KR')},
        date:new Date().toLocaleString('ko-KR')
    };

    // Firebaseì— ì €ì¥
    wbRef.child(num).set(data).then(()=>{
        toast('ğŸ“¦ ìš´ì†¡ì¥ '+num+' ë“±ë¡ ì™„ë£Œ!');
        inp.value='';
        openDetail(num);
    }).catch(err=>{
        alert('ì €ì¥ ì‹¤íŒ¨: '+err.message);
    });
}

// ========== ìƒì„¸ ==========
function openDetail(num, silent){
    tab(2);
    currentView=num;
    const w=wb[num]; if(!w) return;
    if(!silent) toast('ğŸ“‹ ìš´ì†¡ì¥ '+num+' ì¡°íšŒ');

    let sh='';
    for(let i=0;i<ST.length;i++){
        const s=ST[i];
        let dc='',cc='',tm='';
        if(i<w.cs){dc='done';cc='done';tm=w.times[i]||'';}
        else if(i===w.cs){dc='now';tm=w.times[i]||'';}
        sh+=`<div class="step">
            <div class="sl">
                <div class="dot ${dc}">${i<w.cs?'âœ“':s.i}</div>
                ${i<ST.length-1?`<div class="conn ${cc}"></div>`:''}
            </div>
            <div class="sc">
                <div class="t">${s.n}</div>
                ${tm?`<div class="tm">${tm}</div>`:''}
                ${i<=w.cs?`<div class="ds">${s.d}</div>`:''}
            </div>
        </div>`;
    }
    const done=w.cs>=ST.length-1;
    const nx=!done&&ST[w.cs+1];
    document.getElementById('mainArea').innerHTML=`
        <div class="card fade">
            <div class="d-head">
                <h3>ğŸ“¦ ${num}</h3>
                <button class="btn-sm" onclick="showForm()">+ ìƒˆ ìš´ì†¡ì¥</button>
            </div>
            <div class="info-grid">
                <div class="ig"><label>ë¬¼í’ˆëª…</label><span>${w.item}</span></div>
                <div class="ig"><label>ë¬´ê²Œ</label><span>${w.wt}</span></div>
                <div class="ig"><label>ë³´ë‚´ëŠ” ë¶„</label><span>${w.from}</span></div>
                <div class="ig full"><label>ë³´ë‚´ëŠ” ì£¼ì†Œ</label><span>${w.fa}</span></div>
                <div class="ig"><label>ë°›ëŠ” ë¶„</label><span>${w.to}</span></div>
                <div class="ig full"><label>ë°›ëŠ” ì£¼ì†Œ</label><span>${w.ta}</span></div>
                <div class="ig"><label>íƒë°°ì‚¬</label><span>${w.cr}</span></div>
                <div class="ig"><label>ì ‘ìˆ˜ì¼ì‹œ</label><span>${w.date}</span></div>
            </div>
            <div class="steps-title">ğŸ“ ë°°ì†¡ ì§„í–‰ í˜„í™©</div>
            ${sh}
            ${done
                ?'<div class="done-badge">ğŸ‰ ë°°ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>'
                :`<button class="btn-next" onclick="next('${num}')">${nx.i} ë‹¤ìŒ ë‹¨ê³„: ${nx.n}</button>`
            }
        </div>`;
}

// ========== ë‹¤ìŒë‹¨ê³„ (Firebase ì—…ë°ì´íŠ¸) ==========
function next(num){
    const w=wb[num]; if(!w||w.cs>=ST.length-1) return;
    const newStep = w.cs + 1;
    const updates = {};
    updates['cs'] = newStep;
    updates['times/'+newStep] = new Date().toLocaleString('ko-KR');

    wbRef.child(num).update(updates).then(()=>{
        toast(ST[newStep].i+' '+ST[newStep].n);
    }).catch(err=>{
        alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: '+err.message);
    });
}

// ========== ê³ ê° ì¡°íšŒ ==========
function track(){
    const inp=document.getElementById('tInput');
    const num=inp.value.trim();
    const rd=document.getElementById('tResult');
    if(!num){inp.style.borderColor='#ff4757';setTimeout(()=>inp.style.borderColor='#e8e8e8',800);return;}

    // Firebaseì—ì„œ ì‹¤ì‹œê°„ ì¡°íšŒ
    db.ref('waybills/'+num).once('value').then(snap=>{
        const w=snap.val();
        if(!w){
            rd.innerHTML=`<div class="result-card fade"><div class="no-res"><div class="ni">ğŸ”</div><p>ìš´ì†¡ì¥ ë²ˆí˜¸ <b>${num}</b>ì— ëŒ€í•œ<br>ë°°ì†¡ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><p style="font-size:12px;margin-top:6px;color:#ccc">ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”</p></div></div>`;
            return;
        }
        renderTracking(num, w, rd);

        // ì‹¤ì‹œê°„ ê°ì‹œ ì‹œì‘ - ì§ì›ì´ ìƒíƒœ ë°”ê¾¸ë©´ ìë™ ê°±ì‹ 
        db.ref('waybills/'+num).on('value', snap2=>{
            const w2=snap2.val();
            if(w2) renderTracking(num, w2, rd);
        });
    });
}

function renderTracking(num, w, rd){
    let sh='';
    for(let i=0;i<ST.length;i++){
        const s=ST[i];
        let dc='',cc='',tm='';
        if(i<w.cs){dc='done';cc='done';tm=w.times[i]||'';}
        else if(i===w.cs){dc='now';tm=w.times[i]||'';}
        sh+=`<div class="step">
            <div class="sl">
                <div class="dot ${dc}">${i<w.cs?'âœ“':s.i}</div>
                ${i<ST.length-1?`<div class="conn ${cc}"></div>`:''}
            </div>
            <div class="sc">
                <div class="t">${s.n}</div>
                ${tm?`<div class="tm">${tm}</div>`:''}
                ${i<=w.cs?`<div class="ds">${s.d}</div>`:''}
            </div>
        </div>`;
    }
    rd.innerHTML=`
        <div class="result-card fade">
            <div class="r-head">
                <h3>ğŸ“¦ ${num}</h3>
                <span class="cur-st s${w.cs}">${ST[w.cs].i} ${ST[w.cs].n}</span>
            </div>
            <div style="background:#f0f7ff;padding:10px 14px;border-radius:10px;margin-bottom:14px;font-size:12px;color:#667eea;font-weight:600;text-align:center">
                <span class="online-dot"></span> ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘
            </div>
            <div class="info-grid" style="margin-bottom:18px">
                <div class="ig"><label>ë¬¼í’ˆëª…</label><span>${w.item}</span></div>
                <div class="ig"><label>íƒë°°ì‚¬</label><span>${w.cr}</span></div>
                <div class="ig"><label>ë³´ë‚´ëŠ” ë¶„</label><span>${w.from}</span></div>
                <div class="ig"><label>ë°›ëŠ” ë¶„</label><span>${w.to}</span></div>
                <div class="ig full"><label>ë°›ëŠ” ì£¼ì†Œ</label><span>${w.ta}</span></div>
                <div class="ig"><label>ì ‘ìˆ˜ì¼ì‹œ</label><span>${w.date}</span></div>
            </div>
            <div class="steps-title">ğŸ“ ë°°ì†¡ ì¶”ì </div>
            ${sh}
            ${w.cs>=ST.length-1?'<div class="done-badge">ğŸ‰ ë°°ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>':''}
        </div>`;
}
</script>
</body>
</html>
