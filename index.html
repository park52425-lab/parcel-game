<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“¦ íƒë°° ë°°ì†¡ ê²Œì„ v3.0</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;-webkit-tap-highlight-color:transparent}
        html,body{width:100%;overflow-x:hidden;background:#f0f2f5}
        body{min-height:100vh;min-height:100dvh;transition:background .3s,color .3s}
        .screen{display:none;flex-direction:column;min-height:100vh;min-height:100dvh}
        .screen.active{display:flex}
        .btn{padding:14px 24px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;-webkit-appearance:none;appearance:none;transition:all .15s}
        .btn:active{opacity:.85;transform:scale(.97)}
        .btn-primary{background:#667eea;color:#fff}
        input[type=text],textarea{width:100%;padding:14px 16px;border:2px solid #e8e8e8;border-radius:12px;font-size:16px;outline:none;-webkit-appearance:none;appearance:none;background:#fff;transition:border-color .2s}
        input[type=text]:focus,textarea:focus{border-color:#667eea}
        .back-link{color:rgba(255,255,255,.8);text-align:center;padding:16px;font-size:14px;cursor:pointer}
        .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}

        body.dark{background:#1a1a2e;color:#e0e0e0}
        body.dark .top-bar,body.dark .tabs,body.dark .filter-bar{background:#16213e;border-color:#1a1a3e}
        body.dark .wb-card,body.dark .card,body.dark .search-card,body.dark .result-card,body.dark .c-wb-card{background:#16213e;color:#e0e0e0}
        body.dark .wb-card .num,body.dark .card h3,body.dark .d-head h3,body.dark .r-head h3,body.dark .c-wb-card .num{color:#e0e0e0}
        body.dark .wb-card .meta,body.dark .card .desc,body.dark .c-wb-card .meta{color:#888}
        body.dark .ig{background:#0f3460}
        body.dark .ig label{color:#8899aa}
        body.dark .ig span{color:#e0e0e0}
        body.dark input[type=text],body.dark textarea{background:#16213e;border-color:#2a2a4a;color:#e0e0e0}
        body.dark .tab{color:#666}body.dark .tab.on{color:#667eea}
        body.dark .btn-sm{background:#0f3460;color:#667eea}
        body.dark .carrier-box{background:#16213e}body.dark .carrier-box h2{color:#e0e0e0}
        body.dark .carrier-btn{background:#0f3460;border-color:#2a2a4a;color:#e0e0e0}
        body.dark .steps-title,body.dark .sc .t{color:#e0e0e0}
        body.dark .empty-msg p{color:#555}
        body.dark #customerMain{background:linear-gradient(180deg,#667eea 0%,#1a1a2e 30%)}
        body.dark .top-bar h2{color:#e0e0e0}
        body.dark .rank-item,body.dark .shop-item{background:#16213e}
        body.dark .chat-box{background:#0f3460;border-color:#2a2a4a}
        body.dark .chat-msg.customer{background:#2a2a4a;color:#e0e0e0}
        body.dark .modal-box{background:#16213e;color:#e0e0e0}body.dark .modal-box p{color:#aaa}
        body.dark .minigame-area{background:#0f3460}
        body.dark .qr-box{background:#16213e}
        body.dark .c-list-title{color:#e0e0e0}
        body.dark .filter-btn,body.dark .c-filter-btn{background:#0f3460;color:#aaa;border-color:#2a2a4a}
        body.dark .filter-btn.on,body.dark .c-filter-btn.on{color:#667eea}
        body.dark .notif-panel{background:#16213e;border-color:#2a2a4a}
        body.dark .notif-item{border-color:#2a2a4a}
        body.dark .notif-item .ni-text{color:#e0e0e0}
        body.dark .notif-item .ni-time{color:#666}
        body.dark .chatroom-item{background:#16213e;border-color:#2a2a4a}
        body.dark .chatroom-item .cr-name{color:#e0e0e0}
        body.dark .memo-box{background:#0f3460;border-color:#2a2a4a}
        body.dark .graph-bar-bg{background:#2a2a4a}
        body.dark .search-card h2{color:#e0e0e0}
        body.dark .search-card>p{color:#888}

        #roleSelect{justify-content:center;align-items:center;padding:24px;gap:20px}
        #roleSelect h1{color:#fff;font-size:28px;text-align:center}
        #roleSelect>p{color:rgba(255,255,255,.8);font-size:15px}
        .role-cards{display:flex;gap:14px;width:100%;max-width:440px}
        .role-card{flex:1;background:#fff;border-radius:20px;padding:28px 14px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.12);cursor:pointer;transition:transform .15s}
        .role-card:active{transform:scale(.97)}
        .role-card .icon{font-size:48px;margin-bottom:10px}
        .role-card h2{font-size:17px;color:#333;margin-bottom:4px}
        .role-card p{font-size:12px;color:#999}
        .online-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#43a047;margin-right:4px;animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
        .online-info{font-size:12px;color:rgba(255,255,255,.7);margin-top:-8px}

        #carrierSelect{justify-content:center;align-items:center;padding:24px}
        .carrier-box{background:#fff;border-radius:20px;padding:32px 20px;width:100%;max-width:420px;text-align:center;box-shadow:0 16px 50px rgba(0,0,0,.15)}
        .carrier-box h2{font-size:20px;color:#333;margin-bottom:20px}
        .carrier-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .carrier-btn{padding:18px 8px;border:2px solid #eee;border-radius:14px;background:#fff;font-size:14px;font-weight:700;color:#333;cursor:pointer;-webkit-appearance:none}
        .carrier-btn:active{border-color:#667eea;background:#f5f6ff}
        .carrier-btn .ci{font-size:26px;display:block;margin-bottom:4px}

        #staffMain{background:#f0f2f5}
        body.dark #staffMain{background:#1a1a2e}
        .top-bar{background:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,.05);flex-shrink:0;position:sticky;top:0;z-index:50;gap:6px;flex-wrap:wrap}
        .top-bar h2{font-size:13px;color:#333;display:flex;align-items:center;gap:4px;flex-wrap:wrap}
        .badge{background:#667eea;color:#fff;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
        .level-badge{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
        .coin-badge{background:linear-gradient(135deg,#f6d365,#fda085);color:#fff;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
        .ing-badge{background:#43a047;color:#fff;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
        .top-right{display:flex;align-items:center;gap:6px}
        .btn-logout{background:#ff4757;color:#fff;border:none;padding:7px 12px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;flex-shrink:0}
        .btn-icon{background:#555;color:#fff;border:none;padding:6px 8px;border-radius:8px;font-size:14px;cursor:pointer;flex-shrink:0;line-height:1}
        .tabs{display:flex;background:#fff;border-bottom:1px solid #eee;position:sticky;top:46px;z-index:49;flex-shrink:0}
        .tab{flex:1;padding:11px 0;text-align:center;font-size:12px;font-weight:700;color:#aaa;border:none;border-bottom:3px solid transparent;background:none;cursor:pointer;position:relative}
        .tab.on{color:#667eea;border-bottom-color:#667eea}
        .tab-badge{position:absolute;top:4px;right:calc(50% - 20px);background:#ff4757;color:#fff;font-size:9px;padding:1px 5px;border-radius:10px;font-weight:800}
        .panel{display:none;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .panel.on{display:block}

        .filter-bar{display:flex;gap:6px;padding:10px 14px;background:#fff;border-bottom:1px solid #eee;flex-wrap:wrap;align-items:center}
        .filter-btn{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid #e0e0e0;background:#fff;color:#aaa;cursor:pointer}
        .filter-btn.on{border-color:#667eea;color:#667eea;background:#f0f3ff}
        .filter-sep{width:1px;height:18px;background:#e0e0e0;margin:0 2px}

        .list-wrap{padding:14px}
        .wb-card{background:#fff;border-radius:14px;padding:14px 16px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.04);border-left:4px solid #667eea;cursor:pointer;transition:transform .1s}
        .wb-card:active{transform:scale(.98)}
        .wb-card .num{font-weight:700;font-size:15px;color:#333}
        .wb-card .meta{font-size:12px;color:#999;margin-top:2px}
        .wb-card .st{display:inline-block;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700;margin-top:6px}
        .s0{background:#fff3e0;color:#f57c00}.s1{background:#e3f2fd;color:#1976d2}
        .s2{background:#e8eaf6;color:#3f51b5}.s3{background:#e0f2f1;color:#00897b}
        .s4{background:#f3e5f5;color:#8e24aa}.s5{background:#fce4ec;color:#e91e63}
        .s6{background:#e8f5e9;color:#43a047}
        .empty-msg{text-align:center;padding:60px 20px;color:#ccc}
        .empty-msg .ei{font-size:48px;margin-bottom:8px}

        .form-wrap{padding:16px}
        .card{background:#fff;border-radius:16px;padding:24px 18px;box-shadow:0 4px 16px rgba(0,0,0,.06);margin-bottom:14px}
        .card h3{font-size:19px;color:#333;margin-bottom:4px}
        .card .desc{font-size:13px;color:#aaa;margin-bottom:18px}
        .row{display:flex;gap:10px}
        .row input{flex:1;min-width:0}
        .row .btn{flex-shrink:0}

        .d-head{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;padding-bottom:14px;margin-bottom:18px;border-bottom:2px solid #f0f0f0}
        .d-head h3{font-size:17px;color:#333}
        .btn-sm{background:#f0f2f5;color:#667eea;border:none;padding:8px 14px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer}
        .btn-del{background:#ff4757;color:#fff;border:none;padding:8px 14px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer}
        .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:22px}
        .ig{background:#f8f9fa;padding:11px 14px;border-radius:10px}
        .ig.full{grid-column:1/-1}
        .ig label{display:block;font-size:11px;color:#aaa;font-weight:700;margin-bottom:2px}
        .ig span{font-size:13px;color:#333;font-weight:500;word-break:break-all}
        .steps-title{font-size:14px;color:#333;font-weight:700;margin-bottom:14px}
        .step{display:flex;gap:12px}
        .sl{display:flex;flex-direction:column;align-items:center}
        .dot{width:28px;height:28px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;flex-shrink:0;z-index:1}
        .dot.done{background:#43a047}.dot.now{background:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,.25)}
        .conn{width:3px;height:32px;background:#e0e0e0}.conn.done{background:#43a047}
        .sc{padding-top:2px;padding-bottom:18px}
        .sc .t{font-weight:700;font-size:13px;color:#333}
        .sc .tm{font-size:11px;color:#aaa;margin-top:1px}
        .sc .ds{font-size:12px;color:#777;margin-top:1px}
        .btn-next{width:100%;padding:15px;border:none;border-radius:14px;font-size:16px;font-weight:700;color:#fff;cursor:pointer;background:linear-gradient(135deg,#667eea,#764ba2);margin-top:14px}
        .btn-next:active{opacity:.85;transform:scale(.98)}
        .done-badge{background:#e8f5e9;color:#43a047;padding:14px;border-radius:12px;text-align:center;font-weight:700;font-size:15px;margin-top:14px}

        /* ë©”ëª¨ */
        .memo-box{background:#fffde7;border:2px solid #fff9c4;border-radius:12px;padding:12px 14px;margin-bottom:14px}
        .memo-box label{font-size:12px;font-weight:700;color:#f9a825;display:block;margin-bottom:4px}
        .memo-box p{font-size:13px;color:#333}
        body.dark .memo-box p{color:#e0e0e0}

        #customerMain{background:linear-gradient(180deg,#667eea 0%,#f0f2f5 30%)}
        .c-head{padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
        .c-head h2{color:#fff;font-size:17px}
        .c-head .top-right .btn-logout{background:rgba(255,255,255,.2)}
        .c-head .top-right .btn-icon{background:rgba(255,255,255,.2)}
        .c-body{padding:10px 16px 30px;width:100%;max-width:600px;margin:0 auto}
        .search-card{background:#fff;border-radius:20px;padding:28px 18px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,.1);margin-bottom:14px}
        .search-card h2{font-size:20px;color:#333;margin-bottom:4px}
        .search-card>p{font-size:13px;color:#aaa;margin-bottom:18px}
        .search-row{display:flex;gap:10px}
        .search-row input{flex:1;min-width:0}
        .search-row .btn{flex-shrink:0}
        .result-card{background:#fff;border-radius:20px;padding:22px 18px;box-shadow:0 8px 30px rgba(0,0,0,.06);margin-bottom:14px}
        .r-head{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;padding-bottom:12px;margin-bottom:14px;border-bottom:2px solid #f0f0f0}
        .r-head h3{font-size:15px;color:#333}
        .cur-st{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700}
        .no-res{text-align:center;padding:40px 16px;color:#aaa}
        .no-res .ni{font-size:48px;margin-bottom:8px}

        .notif-wrap{position:relative}
        .notif-btn{background:none;border:none;font-size:20px;cursor:pointer;position:relative;padding:4px 6px}
        .notif-count{position:absolute;top:-2px;right:0;background:#ff4757;color:#fff;font-size:9px;font-weight:800;padding:1px 5px;border-radius:10px;min-width:14px;text-align:center;line-height:13px}
        .notif-panel{position:absolute;top:36px;right:0;width:280px;max-height:360px;overflow-y:auto;background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.2);z-index:100;display:none;border:1px solid #eee}
        .notif-panel.open{display:block}
        .notif-header{padding:12px 14px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
        .notif-header h3{font-size:14px;font-weight:700}
        .notif-clear{font-size:11px;color:#667eea;font-weight:700;cursor:pointer;background:none;border:none}
        .notif-item{padding:10px 14px;border-bottom:1px solid #f0f0f0;cursor:pointer}
        .notif-item:active{background:#f5f6ff}
        .notif-item.unread{background:#f0f3ff}
        body.dark .notif-item.unread{background:#1a1a4a}
        .ni-text{font-size:12px;color:#333;font-weight:600}
        .ni-time{font-size:10px;color:#aaa;margin-top:2px}
        .notif-empty{padding:30px;text-align:center;color:#aaa;font-size:12px}

        .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;max-width:90%;text-align:center}
        .toast.show{opacity:1}

        .confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;overflow:hidden}
        .confetti-piece{position:absolute;width:10px;height:10px;top:-10px;animation:confettiFall 3s ease-in forwards}
        @keyframes confettiFall{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
        @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .fade{animation:fadeUp .25s ease}
        @keyframes spin{to{transform:rotate(360deg)}}

        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9000;display:flex;justify-content:center;align-items:center;padding:20px}
        .modal-box{background:#fff;border-radius:20px;padding:32px 24px;max-width:380px;width:100%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:fadeUp .3s ease}
        .modal-box h2{font-size:22px;margin-bottom:8px}
        .modal-box p{font-size:14px;color:#777;margin-bottom:20px;line-height:1.5}
        .modal-btns{display:flex;gap:10px;flex-direction:column}
        .modal-btn{padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer}
        .modal-btn.good{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
        .modal-btn.bad{background:#ff4757;color:#fff}

        .map-box{background:#e8f4fd;border-radius:14px;padding:16px;margin-bottom:18px;position:relative;overflow:hidden;height:180px}
        body.dark .map-box{background:#0a1628}

        .chat-box{border:2px solid #eee;border-radius:14px;padding:12px;margin-top:10px;max-height:250px;overflow-y:auto;background:#fafafa}
        .chat-msg{padding:6px 12px;border-radius:10px;margin-bottom:6px;font-size:13px;max-width:80%;word-break:break-all}
        .chat-msg.staff{background:#667eea;color:#fff;margin-left:auto}
        .chat-msg.customer{background:#e8e8e8;color:#333}
        .chat-msg .sender{font-size:10px;font-weight:700;opacity:.7;margin-bottom:2px}
        .chat-input-row{display:flex;gap:8px;margin-top:8px}
        .chat-input-row input{flex:1;padding:10px 12px;font-size:13px}
        .chat-input-row button{padding:10px 16px;font-size:13px}

        /* ì±„íŒ…ë°© ëª©ë¡ */
        .chatroom-item{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px 16px;margin-bottom:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:transform .1s}
        .chatroom-item:active{transform:scale(.98)}
        .cr-left{flex:1}
        .cr-name{font-weight:700;font-size:14px;color:#333}
        .cr-preview{font-size:12px;color:#999;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
        .cr-badge{background:#ff4757;color:#fff;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:800;flex-shrink:0}

        .star-row{display:flex;gap:4px;justify-content:center;margin:12px 0}
        .star{font-size:32px;cursor:pointer;opacity:.3;transition:opacity .15s}
        .star.on{opacity:1}

        .dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
        .dash-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:16px;padding:18px 14px;text-align:center}
        .dash-card .dv{font-size:28px;font-weight:800}
        .dash-card .dl{font-size:11px;opacity:.8;margin-top:2px}
        .dash-card.gold{background:linear-gradient(135deg,#f6d365,#fda085)}
        .dash-card.green{background:linear-gradient(135deg,#11998e,#38ef7d)}
        .dash-card.pink{background:linear-gradient(135deg,#f093fb,#f5576c)}

        /* ê·¸ë˜í”„ */
        .graph-section{margin-top:18px}
        .graph-title{font-size:14px;font-weight:700;margin-bottom:12px;color:#333}
        body.dark .graph-title{color:#e0e0e0}
        .graph-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
        .graph-label{font-size:12px;font-weight:600;width:80px;text-align:right;color:#666;flex-shrink:0}
        body.dark .graph-label{color:#aaa}
        .graph-bar-bg{flex:1;height:22px;background:#f0f0f0;border-radius:11px;overflow:hidden;position:relative}
        .graph-bar-fill{height:100%;border-radius:11px;transition:width .5s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:10px;font-weight:700;color:#fff;min-width:0}
        .graph-bar-fill.purple{background:linear-gradient(90deg,#667eea,#764ba2)}
        .graph-bar-fill.green{background:linear-gradient(90deg,#11998e,#38ef7d)}
        .graph-bar-fill.orange{background:linear-gradient(90deg,#f6d365,#fda085)}
        .graph-bar-fill.pink{background:linear-gradient(90deg,#f093fb,#f5576c)}
        .graph-bar-fill.blue{background:linear-gradient(90deg,#667eea,#56ccf2)}

        .rank-item{display:flex;align-items:center;gap:12px;padding:12px 14px;background:#fff;border-radius:12px;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
        .rank-num{font-size:20px;font-weight:800;color:#667eea;width:32px;text-align:center}
        .rank-num.g{color:#ffd700}.rank-num.s{color:#c0c0c0}.rank-num.b{color:#cd7f32}

        .exp-bar-wrap{width:100%;background:#e0e0e0;border-radius:10px;height:8px;margin-top:4px;overflow:hidden}
        .exp-bar-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:10px;transition:width .5s ease}

        .mission-bar{background:linear-gradient(90deg,#ff6b6b,#ffa502);color:#fff;padding:10px 16px;font-size:13px;font-weight:700;text-align:center;border-radius:12px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
        .mission-bar .timer{font-size:18px;font-weight:800}

        .recent-list{margin-top:14px}
        .recent-item{display:inline-block;background:#667eea;color:#fff;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;margin:3px;cursor:pointer}

        .qr-box{text-align:center;margin:14px 0;padding:16px;background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
        .qr-canvas{border:4px solid #667eea;border-radius:12px;display:inline-block}

        .special-tag{display:inline-block;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700;margin-left:6px}
        .tag-frozen{background:#e3f2fd;color:#1976d2}
        .tag-fragile{background:#fce4ec;color:#e91e63}
        .tag-express{background:#fff3e0;color:#f57c00}

        .balance-bar{width:100%;height:40px;background:#e0e0e0;border-radius:20px;position:relative;overflow:hidden;margin:12px 0}
        .balance-indicator{width:20px;height:20px;background:#667eea;border-radius:50%;position:absolute;top:10px;transition:left .1s}
        .balance-zone{position:absolute;top:0;height:100%;background:rgba(67,160,71,.2);border-radius:20px}

        .shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .shop-item{background:#fff;border-radius:14px;padding:16px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04);cursor:pointer;border:2px solid transparent;transition:all .15s}
        .shop-item:active{transform:scale(.97)}
        .shop-item.owned{border-color:#43a047}
        .shop-item.equipped{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.3)}
        .shop-item .si{font-size:36px;margin-bottom:6px}
        .shop-item .sn{font-size:13px;font-weight:700}
        .shop-item .sp{font-size:12px;color:#fda085;font-weight:700;margin-top:4px}

        .c-list-title{font-size:15px;font-weight:700;color:#333;margin-bottom:10px;display:flex;align-items:center;gap:6px}
        .c-wb-card{background:#fff;border-radius:14px;padding:14px 16px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.04);border-left:4px solid #667eea;cursor:pointer;transition:transform .1s}
        .c-wb-card:active{transform:scale(.98)}
        .c-wb-card .num{font-weight:700;font-size:15px;color:#333}
        .c-wb-card .meta{font-size:12px;color:#999;margin-top:2px}
        .c-wb-card .st{display:inline-block;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700;margin-top:6px}
        .new-badge{background:#ff4757;color:#fff;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;margin-left:6px;animation:pulse 1s infinite}

        .c-filter-bar{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
        .c-filter-btn{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid #e0e0e0;background:#fff;color:#aaa;cursor:pointer}
        .c-filter-btn.on{border-color:#667eea;color:#667eea;background:#f0f3ff}

        /* ê³ ê° í•˜ë‹¨íƒ­ */
        .c-bottom-tabs{display:flex;background:#fff;border-top:1px solid #eee;position:sticky;bottom:0;z-index:49}
        body.dark .c-bottom-tabs{background:#16213e;border-color:#2a2a4a}
        .c-tab{flex:1;padding:10px 0;text-align:center;font-size:12px;font-weight:700;color:#aaa;border:none;background:none;cursor:pointer;position:relative}
        .c-tab.on{color:#667eea}
        .c-tab-badge{position:absolute;top:2px;right:calc(50% - 16px);background:#ff4757;color:#fff;font-size:9px;padding:1px 5px;border-radius:10px;font-weight:800}

        .c-panel{display:none;flex:1;overflow-y:auto}
        .c-panel.on{display:block}

        @media(min-width:768px){#roleSelect h1{font-size:40px}.role-card{padding:36px 20px}.role-card .icon{font-size:60px}.role-card h2{font-size:20px}}
    </style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- ì—­í• ì„ íƒ -->
<div id="roleSelect" class="screen active gradient-bg">
    <h1>ğŸ“¦ íƒë°° ë°°ì†¡ ê²Œì„</h1>
    <p style="color:rgba(255,255,255,.7);font-size:13px;margin-top:-14px">v3.0</p>
    <p>ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</p>
    <div class="role-cards">
        <div class="role-card" onclick="goStaff()"><div class="icon">ğŸšš</div><h2>íƒë°°ì‚¬ ì§ì›</h2><p>íƒë°°ë¥¼ ì ‘ìˆ˜í•˜ê³  ë°°ì†¡í•´ìš”</p></div>
        <div class="role-card" onclick="goCustomer()"><div class="icon">ğŸ“±</div><h2>ì¼ë°˜ ê³ ê°</h2><p>ë‚´ íƒë°° ì–´ë””ìˆì§€?</p></div>
    </div>
    <p class="online-info"><span class="online-dot"></span>ì‹¤ì‹œê°„ ë©€í‹°í”Œë ˆì´ ì§€ì›</p>
</div>

<!-- íƒë°°ì‚¬ ì„ íƒ -->
<div id="carrierSelect" class="screen gradient-bg">
    <div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:24px">
        <div class="carrier-box"><h2>ğŸ¢ íƒë°°íšŒì‚¬ ì„ íƒ</h2>
            <div class="carrier-grid">
                <button class="carrier-btn" onclick="pickCarrier('CJëŒ€í•œí†µìš´')"><span class="ci">ğŸ“¦</span>CJëŒ€í•œí†µìš´</button>
                <button class="carrier-btn" onclick="pickCarrier('í•œì§„íƒë°°')"><span class="ci">ğŸš›</span>í•œì§„íƒë°°</button>
                <button class="carrier-btn" onclick="pickCarrier('ë¡¯ë°íƒë°°')"><span class="ci">ğŸšš</span>ë¡¯ë°íƒë°°</button>
                <button class="carrier-btn" onclick="pickCarrier('ë¡œì  íƒë°°')"><span class="ci">ğŸ“«</span>ë¡œì  íƒë°°</button>
                <button class="carrier-btn" onclick="pickCarrier('ìš°ì²´êµ­íƒë°°')"><span class="ci">ğŸ£</span>ìš°ì²´êµ­íƒë°°</button>
                <button class="carrier-btn" onclick="pickCarrier('ì¿ íŒ¡ë¡œì¼“')"><span class="ci">ğŸš€</span>ì¿ íŒ¡ë¡œì¼“</button>
            </div>
        </div>
    </div>
    <div class="back-link" onclick="showScr('roleSelect')">â† ë’¤ë¡œê°€ê¸°</div>
</div>

<!-- ì§ì› ë©”ì¸ -->
<div id="staffMain" class="screen">
    <div class="top-bar">
        <h2>ğŸ“¦ <span id="cBadge" class="badge"></span> <span id="levelBadge" class="level-badge"></span> <span id="coinBadge" class="coin-badge"></span> <span id="ingBadge" class="ing-badge"></span></h2>
        <div class="top-right">
            <button class="btn-icon" onclick="toggleSound()" id="soundBtn">ğŸ”Š</button>
            <button class="btn-icon" onclick="toggleDark()" id="darkBtn1">ğŸŒ™</button>
            <button class="btn-logout" onclick="showScr('roleSelect')">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    <div class="tabs">
        <button class="tab on" id="t1" onclick="sTab(1)">ğŸ“‹ ëª©ë¡</button>
        <button class="tab" id="t2" onclick="sTab(2)">ğŸ“ ì…ë ¥</button>
        <button class="tab" id="t3" onclick="sTab(3)">ğŸ’¬ ì±„íŒ…<span class="tab-badge" id="sChatBadge" style="display:none">0</span></button>
        <button class="tab" id="t4" onclick="sTab(4)">ğŸ“Š í†µê³„</button>
        <button class="tab" id="t5" onclick="sTab(5)">ğŸ† ë­í‚¹</button>
        <button class="tab" id="t6" onclick="sTab(6)">ğŸ›’ ìƒì </button>
    </div>
    <div class="filter-bar" id="staffFilterBar">
        <button class="filter-btn on" onclick="setStaffFilter('all')">ì „ì²´</button>
        <button class="filter-btn" onclick="setStaffFilter('ing')">ë°°ì†¡ì¤‘</button>
        <button class="filter-btn" onclick="setStaffFilter('done')">ë°°ì†¡ì™„ë£Œ</button>
        <div class="filter-sep"></div>
        <button class="filter-btn on" onclick="setStaffSort('new')">ìµœì‹ ìˆœ</button>
        <button class="filter-btn" onclick="setStaffSort('old')">ì˜¤ë˜ëœìˆœ</button>
    </div>
    <div class="panel on" id="p1"><div class="list-wrap" id="wList"></div></div>
    <div class="panel" id="p2"><div class="form-wrap" id="mainArea"></div></div>
    <div class="panel" id="p3"><div class="form-wrap" id="sChatArea"></div></div>
    <div class="panel" id="p4"><div class="form-wrap" id="dashArea"></div></div>
    <div class="panel" id="p5"><div class="form-wrap" id="rankArea"></div></div>
    <div class="panel" id="p6"><div class="form-wrap" id="shopArea"></div></div>
</div>

<!-- ê³ ê° ë©”ì¸ -->
<div id="customerMain" class="screen">
    <div class="c-head">
        <h2>ğŸ“¦ íƒë°° ì¡°íšŒ</h2>
        <div class="top-right">
            <div class="notif-wrap">
                <button class="notif-btn" onclick="toggleNotif()">ğŸ””<span class="notif-count" id="notifCount" style="display:none">0</span></button>
                <div class="notif-panel" id="notifPanel">
                    <div class="notif-header"><h3>ì•Œë¦¼</h3><button class="notif-clear" onclick="clearNotifs()">ëª¨ë‘ ì½ìŒ</button></div>
                    <div id="notifList"><div class="notif-empty">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
                </div>
            </div>
            <button class="btn-icon" onclick="toggleSound()" id="soundBtn2">ğŸ”Š</button>
            <button class="btn-icon" onclick="toggleDark()" id="darkBtn2">ğŸŒ™</button>
            <button class="btn-logout" onclick="showScr('roleSelect')">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    <!-- ê³ ê° íŒ¨ë„ -->
    <div class="c-panel on" id="cp1">
        <div class="c-body">
            <div class="search-card fade">
                <h2>ğŸ” ë°°ì†¡ ì¡°íšŒ</h2>
                <p>ìš´ì†¡ì¥ ë²ˆí˜¸, ë¬¼í’ˆëª…, ë°›ëŠ”ë¶„ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰</p>
                <div class="search-row">
                    <input type="text" id="tInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" maxlength="30" onkeypress="if(event.key==='Enter')track()">
                    <button class="btn btn-primary" onclick="track()">ì¡°íšŒ</button>
                </div>
                <div id="recentWrap"></div>
            </div>
            <div id="tResult"></div>
            <div class="c-filter-bar" id="custFilterBar">
                <button class="c-filter-btn on" onclick="setCustFilter('all')">ì „ì²´</button>
                <button class="c-filter-btn" onclick="setCustFilter('ing')">ë°°ì†¡ì¤‘</button>
                <button class="c-filter-btn" onclick="setCustFilter('done')">ë°°ì†¡ì™„ë£Œ</button>
                <div class="filter-sep"></div>
                <button class="c-filter-btn on" onclick="setCustSort('new')">ìµœì‹ ìˆœ</button>
                <button class="c-filter-btn" onclick="setCustSort('old')">ì˜¤ë˜ëœìˆœ</button>
            </div>
            <div id="cListArea"></div>
        </div>
    </div>
    <div class="c-panel" id="cp2">
        <div class="c-body" id="cChatArea"></div>
    </div>
    <!-- í•˜ë‹¨íƒ­ -->
    <div class="c-bottom-tabs">
        <button class="c-tab on" id="ct1" onclick="cTab(1)">ğŸ“¦ ì¡°íšŒ</button>
        <button class="c-tab" id="ct2" onclick="cTab(2)">ğŸ’¬ ì±„íŒ…<span class="c-tab-badge" id="cChatBadge" style="display:none">0</span></button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyASiZJwKTgR5eIEwnZ6NebiwpzB_PGw1WU",authDomain:"abcd-c0ead.firebaseapp.com",databaseURL:"https://abcd-c0ead-default-rtdb.firebaseio.com",projectId:"abcd-c0ead",storageBucket:"abcd-c0ead.firebasestorage.app",messagingSenderId:"1065808686638",appId:"1:1065808686638:web:e36f122d059a8d788b79bf"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database(),wbRef=db.ref('waybills'),chatRef=db.ref('chats'),rankRef=db.ref('rankings');

let role='',carrier='',wb={},currentView='',customerTrackingNum='';
let myExp=0,myLevel=1,myCoins=0,myDeliveries=0;
let missionTimer=null,missionTimeLeft=0,missionActive=false,missionWb='';
let ownedSkins=['ğŸšš'],equippedSkin='ğŸšš';
let prevWbKeys=[],prevWbSnap={};
let notifications=[],notifUnread=0;
let staffFilter='all',staffSort='new',custFilter='all',custSort='new';
let soundOn=true;
let chatData={},prevChatData={},sChatUnread=0,cChatUnread=0;
let openChatRoom='';// í˜„ì¬ ì—´ë ¤ìˆëŠ” ì±„íŒ…ë°©

const ST=[{n:'ìƒí’ˆ ì ‘ìˆ˜',i:'ğŸ“‹',d:'íƒë°° ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'},{n:'ì§‘í•˜ ì™„ë£Œ',i:'ğŸ“¦',d:'ë¬¼ë¥˜ì„¼í„°ì—ì„œ ìƒí’ˆì„ ìˆ˜ê±°í–ˆìŠµë‹ˆë‹¤'},{n:'ì§€ì—­ ë¬¼ë¥˜ì„¼í„° ë„ì°©',i:'ğŸ­',d:'ì§€ì—­ ë¬¼ë¥˜ì„¼í„°ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤'},{n:'ë°°ì†¡ì§€ ë„ì°©',i:'ğŸ¬',d:'ë°°ì†¡ì§€ ê·¼ì²˜ ì„¼í„°ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤'},{n:'ë°°ì†¡ ì¶œë°œ',i:'ğŸšš',d:'ë°°ì†¡ ê¸°ì‚¬ë‹˜ì´ ì¶œë°œí–ˆìŠµë‹ˆë‹¤'},{n:'ë°°ì†¡ ì¤‘',i:'ğŸ“',d:'ê³ ê°ë‹˜ê»˜ ë°°ë‹¬ ì¤‘ì…ë‹ˆë‹¤'},{n:'ë°°ì†¡ ì™„ë£Œ',i:'âœ…',d:'ë°°ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'}];
const ITEMS=['ìš´ë™í™”','ì¥ë‚œê° ë¡œë´‡','ê·¸ë¦¼ì±… ì„¸íŠ¸','ê³¼ì ì„ ë¬¼ì„¸íŠ¸','ë¸”ë¡ ì¥ë‚œê°','ì¸í˜•','í‹°ì…”ì¸ ','í…€ë¸”ëŸ¬','ì´ì–´í°','ì¿ í‚¤ ì„¸íŠ¸','ìƒ‰ì—°í•„ ì„¸íŠ¸','í¼ì¦','ë³´ë“œê²Œì„','ì¶•êµ¬ê³µ','ê°€ë°©','ëª¨ì'];
const NAMES=['ê¹€ë¯¼ì¤€','ì´ì„œì—°','ë°•ì§€í˜¸','ìµœìˆ˜ì•„','ì •ë„ìœ¤','ê°•í•˜ì€','ì¡°ì‹œìš°','ìœ¤ì§€ì•„','ì¥ì˜ˆì¤€','í•œì†Œìœ¨','ì„ê±´ìš°','ì˜¤ë‚˜ìœ¤'];
const CITY=['ì„œìš¸','ë¶€ì‚°','ëŒ€êµ¬','ì¸ì²œ','ê´‘ì£¼','ëŒ€ì „','ìš¸ì‚°','ìˆ˜ì›','ê³ ì–‘','ìš©ì¸','ì„±ë‚¨','ì²­ì£¼','ì²œì•ˆ'];
const ROAD=['í•œë¹›ë¡œ','í–‰ë³µê¸¸','ë¯¸ë˜ë¡œ','í‘¸ë¥¸ê¸¸','ë³„ë¹›ë¡œ','ê¿ˆë‚˜ë¬´ê¸¸','ì‚¬ë‘ë¡œ','í¬ë§ê¸¸','í–‡ì‚´ê¸¸'];
const EVENTS=[{title:'ğŸŒ§ï¸ í­ìš° ê²½ë³´!',desc:'í­ìš°ê°€ ìŸì•„ì§€ê³  ìˆìŠµë‹ˆë‹¤!',good:'ë¹ ë¥´ê²Œ ë°°ì†¡! (+50ì½”ì¸)',bad:'ëŒ€ê¸° (ì‹œê°„ ì§€ì—°)',goodR:{coins:50,time:0},badR:{coins:0,time:10}},{title:'ğŸš— êµí†µ ì²´ì¦!',desc:'ë„ë¡œê°€ ë§‰íˆê³  ìˆì–´ìš”!',good:'ìš°íšŒ ì´ë™ (+30ì½”ì¸)',bad:'ëŒ€ê¸° (ì‹œê°„ ì§€ì—°)',goodR:{coins:30,time:0},badR:{coins:0,time:15}},{title:'ğŸ  ê³ ê° ë¶€ì¬!',desc:'ê³ ê°ë‹˜ì´ ì•ˆ ê³„ì‹­ë‹ˆë‹¤!',good:'ë¬¸ ì• ë°°ì†¡ (+20ì½”ì¸)',bad:'ì¬ë°°ë‹¬ (ì‹œê°„ ì§€ì—°)',goodR:{coins:20,time:0},badR:{coins:0,time:20}},{title:'ğŸ“¦ íŒŒì† ìœ„í—˜!',desc:'ìƒìê°€ ì°Œê·¸ëŸ¬ì¡Œì–´ìš”!',good:'ì¡°ì‹¬íˆ ë°°ì†¡ (+40ì½”ì¸)',bad:'ë¬´ì‹œ (-20ì½”ì¸)',goodR:{coins:40,time:0},badR:{coins:-20,time:0}},{title:'ğŸ ë³´ë„ˆìŠ¤ ë°°ì†¡!',desc:'íŠ¹ê¸‰ ë³´ë„ˆìŠ¤!',good:'ì¦‰ì‹œ ì¶œë°œ! (+80ì½”ì¸)',bad:'ì²œì²œíˆ (+10ì½”ì¸)',goodR:{coins:80,time:0},badR:{coins:10,time:0}},{title:'ğŸ• ê°•ì•„ì§€!',desc:'ë°°ì†¡ì§€ ì•ì— ê°•ì•„ì§€!',good:'ê°„ì‹ ì£¼ê¸° (+30ì½”ì¸)',bad:'ëŒì•„ê°€ê¸° (ì‹œê°„ ì§€ì—°)',goodR:{coins:30,time:0},badR:{coins:0,time:8}}];
const ITEM_TYPES=[{type:'normal',label:'ì¼ë°˜',tag:''},{type:'frozen',label:'ëƒ‰ë™',tag:'<span class="special-tag tag-frozen">ğŸ§Š ëƒ‰ë™</span>',timeLimit:45},{type:'fragile',label:'íŒŒì†ì£¼ì˜',tag:'<span class="special-tag tag-fragile">âš ï¸ íŒŒì†ì£¼ì˜</span>',needMinigame:true},{type:'express',label:'íŠ¹ê¸‰',tag:'<span class="special-tag tag-express">âš¡ íŠ¹ê¸‰</span>',timeLimit:30}];
const LEVEL_NAMES=['ìˆ˜ìŠµ ë°°ì†¡ì›','ì´ˆë³´ ë°°ì†¡ì›','ì¼ë°˜ ë°°ì†¡ì›','ìˆ™ë ¨ ë°°ì†¡ì›','ë² í…Œë‘ ê¸°ì‚¬','ì—ì´ìŠ¤ ê¸°ì‚¬','ë§ˆìŠ¤í„° ê¸°ì‚¬','ì „ì„¤ì˜ ê¸°ì‚¬','íƒë°° í™©ì œ','íƒë°°ì˜ ì‹ '];
const LEVEL_EXP=[0,100,250,500,900,1500,2500,4000,6500,10000];
const SHOP_ITEMS=[{name:'ê¸°ë³¸ íŠ¸ëŸ­',icon:'ğŸšš',price:0},{name:'ìŠ¤í¬ì¸ ì¹´',icon:'ğŸï¸',price:200},{name:'ì˜¤í† ë°”ì´',icon:'ğŸï¸',price:150},{name:'ìì „ê±°',icon:'ğŸš²',price:80},{name:'ë¡œì¼“',icon:'ğŸš€',price:500},{name:'í—¬ë¦¬ì½¥í„°',icon:'ğŸš',price:400},{name:'ìœ ë‹ˆì½˜',icon:'ğŸ¦„',price:800},{name:'UFO',icon:'ğŸ›¸',price:1000},{name:'ì†Œë°©ì°¨',icon:'ğŸš’',price:300},{name:'ê²½ì°°ì°¨',icon:'ğŸš“',price:350}];
const CITY_POS={'ì„œìš¸':{x:48,y:18},'ë¶€ì‚°':{x:78,y:82},'ëŒ€êµ¬':{x:70,y:62},'ì¸ì²œ':{x:38,y:22},'ê´‘ì£¼':{x:35,y:72},'ëŒ€ì „':{x:52,y:48},'ìš¸ì‚°':{x:82,y:68},'ìˆ˜ì›':{x:46,y:30},'ê³ ì–‘':{x:44,y:15},'ìš©ì¸':{x:52,y:34},'ì„±ë‚¨':{x:50,y:28},'ì²­ì£¼':{x:54,y:40},'ì²œì•ˆ':{x:48,y:38}};
const GRAPH_COLORS=['purple','green','orange','pink','blue'];

function pk(a){return a[Math.floor(Math.random()*a.length)]}
function rItemType(){const r=Math.random();if(r<.15)return ITEM_TYPES[1];if(r<.3)return ITEM_TYPES[2];if(r<.45)return ITEM_TYPES[3];return ITEM_TYPES[0];}
function timeAgo(ts){const s=Math.floor((Date.now()-ts)/1000);if(s<60)return s+'ì´ˆ ì „';const m=Math.floor(s/60);if(m<60)return m+'ë¶„ ì „';const h=Math.floor(m/60);if(h<24)return h+'ì‹œê°„ ì „';return Math.floor(h/24)+'ì¼ ì „';}

// ì‚¬ìš´ë“œ
const AudioCtx=window.AudioContext||window.webkitAudioContext;let audioCtx;
function initAudio(){if(!audioCtx)audioCtx=new AudioCtx();}
function playSound(type){if(!soundOn)return;try{initAudio();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);g.gain.value=.1;if(type==='click'){o.frequency.value=800;o.type='sine';g.gain.setValueAtTime(.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.1);o.start();o.stop(audioCtx.currentTime+.1);}else if(type==='success'){o.frequency.value=523;o.type='sine';g.gain.setValueAtTime(.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.3);o.start();o.stop(audioCtx.currentTime+.3);setTimeout(()=>{const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();o2.connect(g2);g2.connect(audioCtx.destination);o2.frequency.value=659;o2.type='sine';g2.gain.setValueAtTime(.1,audioCtx.currentTime);g2.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.3);o2.start();o2.stop(audioCtx.currentTime+.3);},150);setTimeout(()=>{const o3=audioCtx.createOscillator(),g3=audioCtx.createGain();o3.connect(g3);g3.connect(audioCtx.destination);o3.frequency.value=784;o3.type='sine';g3.gain.setValueAtTime(.12,audioCtx.currentTime);g3.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.5);o3.start();o3.stop(audioCtx.currentTime+.5);},300);}else if(type==='levelup'){[523,659,784,1047].forEach((f,i)=>{setTimeout(()=>{const oo=audioCtx.createOscillator(),gg=audioCtx.createGain();oo.connect(gg);gg.connect(audioCtx.destination);oo.frequency.value=f;oo.type='triangle';gg.gain.setValueAtTime(.12,audioCtx.currentTime);gg.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.4);oo.start();oo.stop(audioCtx.currentTime+.4);},i*120);});}else if(type==='coin'){o.frequency.value=1200;o.type='sine';g.gain.setValueAtTime(.08,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.15);o.start();o.stop(audioCtx.currentTime+.15);}else if(type==='alert'){o.frequency.value=400;o.type='sawtooth';g.gain.setValueAtTime(.08,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.3);o.start();o.stop(audioCtx.currentTime+.3);}else if(type==='notify'){o.frequency.value=880;o.type='sine';g.gain.setValueAtTime(.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.2);o.start();o.stop(audioCtx.currentTime+.2);}}catch(e){}}
function vibrate(ms){try{navigator.vibrate&&navigator.vibrate(ms);}catch(e){}}

function toggleSound(){soundOn=!soundOn;document.querySelectorAll('#soundBtn,#soundBtn2').forEach(b=>b.textContent=soundOn?'ğŸ”Š':'ğŸ”‡');}

function confetti(){const c=document.createElement('div');c.className='confetti-container';document.body.appendChild(c);const cols=['#667eea','#764ba2','#f093fb','#f5576c','#43a047','#ffd700','#ff6b6b','#fda085','#38ef7d'];for(let i=0;i<80;i++){const p=document.createElement('div');p.className='confetti-piece';p.style.left=Math.random()*100+'%';p.style.background=cols[Math.floor(Math.random()*cols.length)];p.style.width=(Math.random()*8+6)+'px';p.style.height=(Math.random()*8+6)+'px';p.style.borderRadius=Math.random()>.5?'50%':'2px';p.style.animationDelay=Math.random()*2+'s';p.style.animationDuration=(Math.random()*2+2)+'s';c.appendChild(p);}setTimeout(()=>c.remove(),4000);}

function toggleDark(){document.body.classList.toggle('dark');const d=document.body.classList.contains('dark');document.querySelectorAll('#darkBtn1,#darkBtn2').forEach(b=>b.textContent=d?'â˜€ï¸':'ğŸŒ™');localStorage.setItem('darkMode',d);}
if(localStorage.getItem('darkMode')==='true')document.body.classList.add('dark');
document.addEventListener('DOMContentLoaded',()=>{if(document.body.classList.contains('dark'))document.querySelectorAll('#darkBtn1,#darkBtn2').forEach(b=>b.textContent='â˜€ï¸');});

function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2500);}
function showScr(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}

// ì•Œë¦¼
function addNotif(icon,text,wbNum){notifications.unshift({icon,text,wbNum,time:Date.now(),read:false});if(notifications.length>50)notifications.pop();notifUnread++;updateNotifBadge();renderNotifList();}
function updateNotifBadge(){const el=document.getElementById('notifCount');if(notifUnread>0){el.style.display='inline';el.textContent=notifUnread>99?'99+':notifUnread;}else el.style.display='none';}
function toggleNotif(){document.getElementById('notifPanel').classList.toggle('open');}
function clearNotifs(){notifications.forEach(n=>n.read=true);notifUnread=0;updateNotifBadge();renderNotifList();}
function renderNotifList(){const el=document.getElementById('notifList');if(!notifications.length){el.innerHTML='<div class="notif-empty">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';return;}el.innerHTML=notifications.map((n,i)=>`<div class="notif-item ${n.read?'':'unread'}" onclick="notifClick(${i})"><span style="margin-right:6px">${n.icon}</span><span class="ni-text">${n.text}</span><div class="ni-time">${timeAgo(n.time)}</div></div>`).join('');}
function notifClick(idx){const n=notifications[idx];if(!n.read){n.read=true;notifUnread=Math.max(0,notifUnread-1);updateNotifBadge();renderNotifList();}document.getElementById('notifPanel').classList.remove('open');if(n.wbNum&&wb[n.wbNum]){cTab(1);trackDirect(n.wbNum);}}
document.addEventListener('click',e=>{const w=document.querySelector('.notif-wrap');if(w&&!w.contains(e.target))document.getElementById('notifPanel').classList.remove('open');});

// ì‹¤ì‹œê°„
wbRef.on('value',snap=>{
    const nw=snap.val()||{},nk=Object.keys(nw);
    if(role==='customer'&&prevWbKeys.length>0){
        nk.filter(k=>!prevWbKeys.includes(k)).forEach(k=>{playSound('notify');vibrate(100);toast('ğŸ“¦ ìƒˆ íƒë°°! '+k);addNotif('ğŸ“¦','ìƒˆ íƒë°°: '+k+' ('+nw[k].item+')',k);});
        nk.forEach(k=>{if(prevWbSnap[k]&&nw[k]&&prevWbSnap[k].cs!==nw[k].cs){playSound('notify');vibrate(80);toast(ST[nw[k].cs].i+' '+k+' â†’ '+ST[nw[k].cs].n);addNotif(ST[nw[k].cs].i,k+' â†’ '+ST[nw[k].cs].n,k);}});
    }
    prevWbKeys=nk;prevWbSnap=JSON.parse(JSON.stringify(nw));wb=nw;
    if(role==='staff'){renderList();updateIngBadge();}
    if(role==='customer')renderCustomerList();
    if(currentView&&wb[currentView]&&role==='staff')openDetail(currentView,true);
    if(customerTrackingNum&&wb[customerTrackingNum])renderTracking(customerTrackingNum,wb[customerTrackingNum],document.getElementById('tResult'));
});

// ì±„íŒ… ì‹¤ì‹œê°„
chatRef.on('value',snap=>{
    const nd=snap.val()||{};
    // ìƒˆ ë©”ì‹œì§€ ê°ì§€
    if(Object.keys(prevChatData).length>0){
        Object.keys(nd).forEach(num=>{
            const newMsgs=nd[num]||{},oldMsgs=prevChatData[num]||{};
            const newKeys=Object.keys(newMsgs).filter(k=>!oldMsgs[k]);
            newKeys.forEach(k=>{
                const m=newMsgs[k];
                if(role==='staff'&&m.role==='customer'&&openChatRoom!==num){sChatUnread++;updateSChatBadge();}
                if(role==='customer'&&m.role==='staff'&&openChatRoom!==num){cChatUnread++;updateCChatBadge();addNotif('ğŸ’¬','íƒë°°ì› ë©”ì‹œì§€: '+m.text,num);}
            });
        });
    }
    prevChatData=JSON.parse(JSON.stringify(nd));chatData=nd;
    if(role==='staff')renderStaffChatList();
    if(role==='customer')renderCustChatList();
    // ì—´ë ¤ìˆëŠ” ì±„íŒ…ë°© ê°±ì‹ 
    if(openChatRoom)renderChatMessages(openChatRoom);
});

function updateSChatBadge(){const el=document.getElementById('sChatBadge');if(sChatUnread>0){el.style.display='inline';el.textContent=sChatUnread;}else el.style.display='none';}
function updateCChatBadge(){const el=document.getElementById('cChatBadge');if(cChatUnread>0){el.style.display='inline';el.textContent=cChatUnread;}else el.style.display='none';}

function goStaff(){role='staff';loadUserData();showScr('carrierSelect');}
function goCustomer(){role='customer';prevWbKeys=Object.keys(wb);prevWbSnap=JSON.parse(JSON.stringify(wb));prevChatData=JSON.parse(JSON.stringify(chatData));notifications=[];notifUnread=0;cChatUnread=0;updateNotifBadge();renderNotifList();updateCChatBadge();loadRecentSearches();showScr('customerMain');renderCustomerList();renderCustChatList();}

function pickCarrier(c){carrier=c;document.getElementById('cBadge').textContent=c;playSound('click');prevChatData=JSON.parse(JSON.stringify(chatData));sChatUnread=0;updateSChatBadge();showScr('staffMain');updateTopBar();updateIngBadge();renderList();showForm();renderDashboard();renderRankings();renderShop();renderStaffChatList();}

function sTab(n){for(let i=1;i<=6;i++){document.getElementById('t'+i).classList.toggle('on',i===n);document.getElementById('p'+i).classList.toggle('on',i===n);}document.getElementById('staffFilterBar').style.display=n===1?'flex':'none';if(n===3){sChatUnread=0;updateSChatBadge();renderStaffChatList();}if(n===4)renderDashboard();if(n===5)renderRankings();if(n===6)renderShop();}
function cTab(n){document.getElementById('ct1').classList.toggle('on',n===1);document.getElementById('ct2').classList.toggle('on',n===2);document.getElementById('cp1').classList.toggle('on',n===1);document.getElementById('cp2').classList.toggle('on',n===2);if(n===2){cChatUnread=0;updateCChatBadge();renderCustChatList();}}

function loadUserData(){const s=localStorage.getItem('deliveryGame_staff');if(s){const d=JSON.parse(s);myExp=d.exp||0;myLevel=d.level||1;myCoins=d.coins||0;myDeliveries=d.deliveries||0;ownedSkins=d.ownedSkins||['ğŸšš'];equippedSkin=d.equippedSkin||'ğŸšš';}updateTopBar();}
function saveUserData(){localStorage.setItem('deliveryGame_staff',JSON.stringify({exp:myExp,level:myLevel,coins:myCoins,deliveries:myDeliveries,ownedSkins,equippedSkin}));rankRef.child('staff').set({name:'íƒë°°ì›',deliveries:myDeliveries,exp:myExp,level:myLevel,carrier});}
function addExp(a){myExp+=a;const ol=myLevel;for(let i=LEVEL_EXP.length-1;i>=0;i--)if(myExp>=LEVEL_EXP[i]){myLevel=i+1;break;}if(myLevel>ol){playSound('levelup');vibrate([100,50,100,50,200]);confetti();toast('ğŸ‰ ë ˆë²¨ ì—…! Lv.'+myLevel+' '+LEVEL_NAMES[myLevel-1]);}updateTopBar();saveUserData();}
function addCoins(a){myCoins+=a;if(a>0)playSound('coin');updateTopBar();saveUserData();}
function updateTopBar(){document.getElementById('levelBadge').textContent='Lv.'+myLevel+' '+LEVEL_NAMES[Math.min(myLevel-1,LEVEL_NAMES.length-1)];document.getElementById('coinBadge').textContent='ğŸ’°'+myCoins;}
function updateIngBadge(){const cnt=Object.keys(wb).filter(k=>wb[k].cs<6).length;document.getElementById('ingBadge').textContent='ë°°ì†¡ì¤‘ '+cnt+'ê±´';}
function getExpPct(){const n=LEVEL_EXP[Math.min(myLevel,LEVEL_EXP.length-1)],p=LEVEL_EXP[Math.min(myLevel-1,LEVEL_EXP.length-1)];return Math.min(100,((myExp-p)/(n-p))*100);}
function getNextExp(){return Math.max(0,LEVEL_EXP[Math.min(myLevel,LEVEL_EXP.length-1)]-myExp);}

// í•„í„°
function setStaffFilter(f){staffFilter=f;document.querySelectorAll('#staffFilterBar .filter-btn').forEach((b,i)=>{if(i<3)b.classList.toggle('on',['ì „ì²´','ë°°ì†¡ì¤‘','ë°°ì†¡ì™„ë£Œ'][i]==={all:'ì „ì²´',ing:'ë°°ì†¡ì¤‘',done:'ë°°ì†¡ì™„ë£Œ'}[f]);});renderList();}
function setStaffSort(s){staffSort=s;document.querySelectorAll('#staffFilterBar .filter-btn').forEach((b,i)=>{if(i>=4)b.classList.toggle('on',['ìµœì‹ ìˆœ','ì˜¤ë˜ëœìˆœ'][i-4]==={new:'ìµœì‹ ìˆœ',old:'ì˜¤ë˜ëœìˆœ'}[s]);});renderList();}
function setCustFilter(f){custFilter=f;document.querySelectorAll('#custFilterBar .c-filter-btn').forEach((b,i)=>{if(i<3)b.classList.toggle('on',['ì „ì²´','ë°°ì†¡ì¤‘','ë°°ì†¡ì™„ë£Œ'][i]==={all:'ì „ì²´',ing:'ë°°ì†¡ì¤‘',done:'ë°°ì†¡ì™„ë£Œ'}[f]);});renderCustomerList();}
function setCustSort(s){custSort=s;document.querySelectorAll('#custFilterBar .c-filter-btn').forEach((b,i)=>{if(i>=4)b.classList.toggle('on',['ìµœì‹ ìˆœ','ì˜¤ë˜ëœìˆœ'][i-4]==={new:'ìµœì‹ ìˆœ',old:'ì˜¤ë˜ëœìˆœ'}[s]);});renderCustomerList();}
function filterSort(keys,f,s){let r=keys;if(f==='ing')r=keys.filter(k=>wb[k].cs<6);else if(f==='done')r=keys.filter(k=>wb[k].cs>=6);r.sort((a,b)=>{const ta=wb[a].startTime||0,tb=wb[b].startTime||0;return s==='new'?tb-ta:ta-tb;});return r;}

function renderList(){
    const el=document.getElementById('wList');let keys=Object.keys(wb);
    if(!keys.length){el.innerHTML='<div class="empty-msg"><div class="ei">ğŸ“­</div><p>ë“±ë¡ëœ ìš´ì†¡ì¥ì´ ì—†ì–´ìš”</p></div>';return;}
    keys=filterSort(keys,staffFilter,staffSort);
    if(!keys.length){el.innerHTML='<div class="empty-msg"><div class="ei">ğŸ”</div><p>ì¡°ê±´ì— ë§ëŠ” ìš´ì†¡ì¥ì´ ì—†ì–´ìš”</p></div>';return;}
    el.innerHTML=keys.map(k=>{const w=wb[k],s=w.cs,ti=ITEM_TYPES.find(t=>t.type===w.itemType)||ITEM_TYPES[0];return `<div class="wb-card" onclick="openDetail('${k}')"><div class="num">${equippedSkin} ${k} ${ti.tag}</div><div class="meta">${w.item} Â· ${w.wt} Â· ${w.cr}</div><span class="st s${s}">${ST[s].i} ${ST[s].n}</span></div>`;}).join('');
}

function showForm(){
    currentView='';
    document.getElementById('mainArea').innerHTML=`<div class="card fade"><h3>ğŸ“ ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥</h3><p class="desc">ìƒˆ íƒë°°ë¥¼ ë“±ë¡í•˜ì„¸ìš”</p><div class="row"><input type="text" id="wInput" placeholder="ìš´ì†¡ì¥ ë²ˆí˜¸" maxlength="15" inputmode="numeric" onkeypress="if(event.key==='Enter')reg()"><button class="btn btn-primary" onclick="reg()">ë“±ë¡</button></div></div>
    <div class="card"><h3>${equippedSkin} ë‚´ ì •ë³´</h3><div class="info-grid"><div class="ig"><label>ë ˆë²¨</label><span>Lv.${myLevel} ${LEVEL_NAMES[Math.min(myLevel-1,LEVEL_NAMES.length-1)]}</span></div><div class="ig"><label>ì½”ì¸</label><span>ğŸ’°${myCoins}</span></div><div class="ig"><label>ì´ ë°°ì†¡</label><span>ğŸ“¦${myDeliveries}ê±´</span></div><div class="ig"><label>ê²½í—˜ì¹˜</label><span>â­${myExp}</span></div></div><div class="exp-bar-wrap"><div class="exp-bar-fill" style="width:${getExpPct()}%"></div></div><p style="font-size:11px;color:#aaa;text-align:center;margin-top:4px">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${getNextExp()} EXP</p></div>`;
}

function reg(){
    const inp=document.getElementById('wInput'),num=inp.value.trim();
    if(!num){inp.style.borderColor='#ff4757';setTimeout(()=>inp.style.borderColor='#e8e8e8',800);return;}
    if(wb[num]){alert('ì´ë¯¸ ë“±ë¡ëœ ë²ˆí˜¸!');return;}
    const it=rItemType(),fc=pk(CITY),tc=pk(CITY.filter(c=>c!==fc));
    const data={item:pk(ITEMS),wt:(Math.random()*9+.5).toFixed(1)+'kg',from:pk(NAMES),fa:fc+' '+pk(ROAD)+' '+Math.floor(Math.random()*200+1)+'ë²ˆê¸¸',to:pk(NAMES),ta:tc+' '+pk(ROAD)+' '+Math.floor(Math.random()*50+1)+'í˜¸',fromCity:fc,toCity:tc,cr:carrier,cs:0,times:{0:new Date().toLocaleString('ko-KR')},date:new Date().toLocaleString('ko-KR'),itemType:it.type,rating:0,review:'',memo:'',startTime:Date.now()};
    playSound('success');vibrate(100);
    wbRef.child(num).set(data).then(()=>{toast('ğŸ“¦ '+num+' ë“±ë¡!');inp.value='';addExp(10);addCoins(5);if(it.timeLimit)startMission(num,it.timeLimit);openDetail(num);}).catch(err=>alert('ì‹¤íŒ¨: '+err.message));
}

function deleteWb(num){if(!confirm('ìš´ì†¡ì¥ '+num+'ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;wbRef.child(num).remove().then(()=>{chatRef.child(num).remove();toast('ğŸ—‘ï¸ '+num+' ì‚­ì œë¨');playSound('click');showForm();}).catch(err=>alert('ì‚­ì œ ì‹¤íŒ¨'));}

function startMission(num,sec){if(missionTimer)clearInterval(missionTimer);missionActive=true;missionWb=num;missionTimeLeft=sec;toast('â° ë¯¸ì…˜! '+sec+'ì´ˆ!');playSound('alert');missionTimer=setInterval(()=>{missionTimeLeft--;if(missionTimeLeft<=0){clearInterval(missionTimer);missionActive=false;toast('â° ì‹œê°„ ì´ˆê³¼!');playSound('alert');}if(currentView===num)openDetail(num,true);},1000);}

function renderMap(fc,tc,prog){
    const fp=CITY_POS[fc]||{x:50,y:50},tp=CITY_POS[tc]||{x:50,y:50};
    const cx=fp.x+(tp.x-fp.x)*prog/6,cy=fp.y+(tp.y-fp.y)*prog/6;
    const isDark=document.body.classList.contains('dark');
    const bg=isDark?'#0a1628':'#e8f4fd',land=isDark?'#1a3a2a':'#c8e6c9',stroke=isDark?'#2d5a3d':'#81c784',txtC=isDark?'#aaa':'#333';
    return `<div class="map-box"><svg class="map-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        <rect width="100" height="100" fill="${bg}" rx="4"/>
        <path d="M40,8 C38,12 35,18 36,25 C34,30 38,35 40,40 C42,45 48,50 50,55 C48,60 42,65 38,70 C35,75 33,80 35,85 C38,88 42,86 45,82 C48,78 52,75 55,70 C58,65 62,60 65,55 C68,50 72,45 75,40 C78,35 80,30 78,25 C75,20 70,18 65,15 C60,12 55,10 50,8 C45,7 42,7 40,8Z" fill="${land}" stroke="${stroke}" stroke-width="0.5"/>
        <line x1="${fp.x}" y1="${fp.y}" x2="${tp.x}" y2="${tp.y}" stroke="#667eea" stroke-width="0.8" stroke-dasharray="2,2" opacity="0.5"/>
        <circle cx="${fp.x}" cy="${fp.y}" r="2.5" fill="#43a047"/><text x="${fp.x}" y="${fp.y-4}" text-anchor="middle" font-size="3" fill="${txtC}" font-weight="bold">${fc}</text>
        <circle cx="${tp.x}" cy="${tp.y}" r="2.5" fill="#e91e63"/><text x="${tp.x}" y="${tp.y-4}" text-anchor="middle" font-size="3" fill="${txtC}" font-weight="bold">${tc}</text>
        <text x="${cx}" y="${cy}" text-anchor="middle" font-size="5" dominant-baseline="central">${equippedSkin}</text>
    </svg></div>`;
}

function openDetail(num,silent){
    sTab(2);currentView=num;const w=wb[num];if(!w)return;
    if(!silent){playSound('click');toast('ğŸ“‹ '+num);}
    const ti=ITEM_TYPES.find(t=>t.type===w.itemType)||ITEM_TYPES[0];
    let sh='';for(let i=0;i<ST.length;i++){const s=ST[i];let dc='',cc='',tm='';if(i<w.cs){dc='done';cc='done';tm=w.times[i]||'';}else if(i===w.cs){dc='now';tm=w.times[i]||'';}sh+=`<div class="step"><div class="sl"><div class="dot ${dc}">${i<w.cs?'âœ“':s.i}</div>${i<ST.length-1?`<div class="conn ${cc}"></div>`:''}</div><div class="sc"><div class="t">${s.n}</div>${tm?`<div class="tm">${tm}</div>`:''}${i<=w.cs?`<div class="ds">${s.d}</div>`:''}</div></div>`;}
    const done=w.cs>=6,nx=!done&&ST[w.cs+1];
    let miss='';if(missionActive&&missionWb===num)miss=`<div class="mission-bar" ${missionTimeLeft<=10?'style="background:#ff4757"':''}><span>â° ë¯¸ì…˜!</span><span class="timer">${missionTimeLeft}ì´ˆ</span></div>`;
    let map=w.fromCity&&w.toCity?renderMap(w.fromCity,w.toCity,w.cs):'';
    let memo='';if(w.memo)memo=`<div class="memo-box"><label>ğŸ“ ê³ ê° ìš”ì²­ì‚¬í•­</label><p>${w.memo}</p></div>`;
    let rev='';if(done&&w.rating)rev=`<div class="card" style="margin-top:14px;text-align:center"><h3>â­ ê³ ê° í‰ê°€</h3><div style="font-size:28px;margin:8px 0">${'â­'.repeat(w.rating)}${'â˜†'.repeat(5-w.rating)}</div>${w.review?`<p style="font-size:13px;color:#666;font-style:italic">"${w.review}"</p>`:''}</div>`;
    let qr=`<div class="qr-box"><p style="font-size:13px;font-weight:700;margin-bottom:8px">ğŸ“± QR</p><canvas id="qrCanvas" width="120" height="120" class="qr-canvas"></canvas></div>`;
    let chat=`<div style="margin-top:14px"><p style="font-size:14px;font-weight:700;margin-bottom:8px">ğŸ’¬ ê³ ê°ê³¼ ì†Œí†µ</p><div class="chat-box" id="chatBox_s_${num}"></div><div class="chat-input-row"><input type="text" id="chatIn_s_${num}" placeholder="ë©”ì‹œì§€..." maxlength="100" onkeypress="if(event.key==='Enter')sendMsg('${num}','staff')"><button class="btn btn-primary" onclick="sendMsg('${num}','staff')" style="padding:10px 16px;font-size:13px">ì „ì†¡</button></div></div>`;
    document.getElementById('mainArea').innerHTML=`<div class="card fade">
        <div class="d-head"><h3>${equippedSkin} ${num} ${ti.tag}</h3><div><button class="btn-sm" onclick="showForm()">+ ìƒˆ ìš´ì†¡ì¥</button> <button class="btn-del" onclick="deleteWb('${num}')">ğŸ—‘ï¸ ì‚­ì œ</button></div></div>
        ${miss}${map}${memo}
        <div class="info-grid">
            <div class="ig"><label>ë¬¼í’ˆëª…</label><span>${w.item}</span></div><div class="ig"><label>ë¬´ê²Œ</label><span>${w.wt}</span></div>
            <div class="ig"><label>ë³´ë‚´ëŠ” ë¶„</label><span>${w.from}</span></div><div class="ig full"><label>ë³´ë‚´ëŠ” ì£¼ì†Œ</label><span>${w.fa}</span></div>
            <div class="ig"><label>ë°›ëŠ” ë¶„</label><span>${w.to}</span></div><div class="ig full"><label>ë°›ëŠ” ì£¼ì†Œ</label><span>${w.ta}</span></div>
            <div class="ig"><label>íƒë°°ì‚¬</label><span>${w.cr}</span></div><div class="ig"><label>ì ‘ìˆ˜ì¼ì‹œ</label><span>${w.date}</span></div>
            <div class="ig"><label>ë¬¼í’ˆìœ í˜•</label><span>${ti.label}</span></div>
        </div>
        <div class="steps-title">ğŸ“ ë°°ì†¡ í˜„í™©</div>${sh}
        ${done?'<div class="done-badge">ğŸ‰ ë°°ì†¡ ì™„ë£Œ!</div>':`<button class="btn-next" onclick="tryNext('${num}')">${nx.i} ë‹¤ìŒ: ${nx.n}</button>`}
        ${qr}${chat}
    </div>${rev}`;
    setTimeout(()=>drawQR(num),100);
    loadChatRoom('s_',num);
}

function tryNext(num){const w=wb[num];if(!w)return;if(w.itemType==='fragile'&&w.cs>=3&&w.cs<=5&&!w.minigameDone){showMinigame(num);return;}if(Math.random()<.3&&w.cs>0&&w.cs<5){showEvent(num);return;}doNext(num);}
function doNext(num){
    const w=wb[num];if(!w||w.cs>=6)return;const ns=w.cs+1,u={};u['cs']=ns;u['times/'+ns]=new Date().toLocaleString('ko-KR');
    let exp=15+ns*5,coin=10+ns*3;
    if(missionActive&&missionWb===num&&missionTimeLeft>0){coin+=Math.floor(missionTimeLeft*2);exp+=missionTimeLeft;}
    if(w.itemType==='express')coin+=10;
    if(ns>=6){u['completedAt']=Date.now();myDeliveries++;exp+=50;coin+=30;if(missionActive&&missionWb===num){clearInterval(missionTimer);missionActive=false;}}
    wbRef.child(num).update(u).then(()=>{playSound(ns>=6?'success':'click');vibrate(ns>=6?[100,50,100,50,200]:80);toast(ST[ns].i+' '+ST[ns].n);addExp(exp);addCoins(coin);if(ns>=6){confetti();toast('ğŸ‰ ì™„ë£Œ! +'+coin+'ì½”ì¸');}});
}

function showEvent(num){const e=pk(EVENTS);playSound('alert');vibrate([100,50,100]);const o=document.createElement('div');o.className='modal-overlay';o.innerHTML=`<div class="modal-box fade"><h2>${e.title}</h2><p>${e.desc}</p><div class="modal-btns"><button class="modal-btn good" onclick="resolveEv(this,'${num}',${e.goodR.coins},${e.goodR.time})">${e.good}</button><button class="modal-btn bad" onclick="resolveEv(this,'${num}',${e.badR.coins},${e.badR.time})">${e.bad}</button></div></div>`;document.body.appendChild(o);}
function resolveEv(btn,num,coins,tp){btn.closest('.modal-overlay').remove();if(coins>0){addCoins(coins);toast('ğŸ’°+'+coins);}else if(coins<0){addCoins(coins);toast('ğŸ’¸'+coins);}if(tp>0&&missionActive){missionTimeLeft=Math.max(0,missionTimeLeft-tp);toast('â°-'+tp+'ì´ˆ');}playSound(coins>=0?'success':'alert');doNext(num);}

function showMinigame(num){
    playSound('alert');const o=document.createElement('div');o.className='modal-overlay';o.id='mgOverlay';
    o.innerHTML=`<div class="modal-box fade"><h2>âš ï¸ íŒŒì†ì£¼ì˜!</h2><p>ì´ˆë¡ ì•ˆì— ê³µì„ ìœ ì§€í•˜ì„¸ìš”!</p><div style="padding:20px"><div class="balance-bar"><div class="balance-zone" style="left:35%;width:30%"></div><div class="balance-indicator" id="balInd" style="left:50%"></div></div><div style="display:flex;gap:10px;justify-content:center;margin-top:12px"><button class="btn btn-primary" onmousedown="mgM(-1)" ontouchstart="mgM(-1)" style="padding:14px 28px;font-size:20px">â¬…ï¸</button><button class="btn btn-primary" onmousedown="mgM(1)" ontouchstart="mgM(1)" style="padding:14px 28px;font-size:20px">â¡ï¸</button></div><p style="margin-top:8px;font-weight:700;font-size:16px" id="mgT">3ì´ˆ</p></div></div>`;
    document.body.appendChild(o);let tl=3;window._mp=50;
    window.mgM=d=>{window._mp=Math.max(5,Math.min(95,window._mp+d*8));const e=document.getElementById('balInd');if(e)e.style.left=window._mp+'%';};
    const dr=setInterval(()=>{window._mp+=(Math.random()-.5)*6;window._mp=Math.max(5,Math.min(95,window._mp));const e=document.getElementById('balInd');if(e)e.style.left=window._mp+'%';},200);
    const cd=setInterval(()=>{tl--;const e=document.getElementById('mgT');if(e)e.textContent=tl+'ì´ˆ';if(tl<=0){clearInterval(dr);clearInterval(cd);const ov=document.getElementById('mgOverlay');if(ov)ov.remove();if(window._mp>=35&&window._mp<=65){toast('âœ… ì•ˆì „! +30ì½”ì¸');addCoins(30);}else toast('ğŸ’¥ ìœ„í—˜í–ˆì§€ë§Œ ì§„í–‰!');wbRef.child(num).update({minigameDone:true}).then(()=>doNext(num));}},1000);
}

function drawQR(num){const c=document.getElementById('qrCanvas');if(!c)return;const x=c.getContext('2d');x.fillStyle='#fff';x.fillRect(0,0,120,120);x.fillStyle='#000';dQC(x,4,4,24);dQC(x,92,4,24);dQC(x,4,92,24);const h=num.split('').reduce((a,c)=>a+c.charCodeAt(0),0);for(let y=0;y<10;y++)for(let i=0;i<10;i++)if((h*(i+1)*(y+1))%3===0)x.fillRect(32+i*6,32+y*6,5,5);x.fillStyle='#667eea';x.font='bold 8px sans-serif';x.textAlign='center';x.fillText(num,60,64);}
function dQC(x,a,b,s){x.fillRect(a,b,s,s);x.fillStyle='#fff';x.fillRect(a+3,b+3,s-6,s-6);x.fillStyle='#000';x.fillRect(a+6,b+6,s-12,s-12);}

// ì±„íŒ… ê³µìš©
function loadChatRoom(prefix,num){
    const boxId='chatBox_'+prefix+num;
    openChatRoom=num;
    chatRef.child(num).on('value',snap=>{
        const msgs=snap.val()||{},box=document.getElementById(boxId);if(!box)return;
        box.innerHTML=Object.keys(msgs).sort().map(k=>{const m=msgs[k];return `<div class="chat-msg ${m.role}"><div class="sender">${m.role==='staff'?'ğŸšš íƒë°°ì›':'ğŸ“± ê³ ê°'}</div>${m.text}</div>`;}).join('');
        box.scrollTop=box.scrollHeight;
    });
}
function renderChatMessages(num){
    ['s_','c_'].forEach(prefix=>{
        const box=document.getElementById('chatBox_'+prefix+num);if(!box)return;
        const msgs=chatData[num]||{};
        box.innerHTML=Object.keys(msgs).sort().map(k=>{const m=msgs[k];return `<div class="chat-msg ${m.role}"><div class="sender">${m.role==='staff'?'ğŸšš íƒë°°ì›':'ğŸ“± ê³ ê°'}</div>${m.text}</div>`;}).join('');
        box.scrollTop=box.scrollHeight;
    });
}
function sendMsg(num,r){const id=r==='staff'?'chatIn_s_'+num:'chatIn_c_'+num;const inp=document.getElementById(id);if(!inp)return;const t=inp.value.trim();if(!t)return;chatRef.child(num).push({role:r,text:t,time:Date.now()});inp.value='';playSound('click');}

// ì§ì› ì±„íŒ… íƒ­
function renderStaffChatList(){
    const el=document.getElementById('sChatArea');const keys=Object.keys(wb);
    if(!keys.length){el.innerHTML='<div class="card"><h3>ğŸ’¬ ì±„íŒ…</h3><p class="desc">ë“±ë¡ëœ íƒë°°ê°€ ì—†ì–´ìš”</p></div>';return;}
    el.innerHTML=`<div class="card fade"><h3>ğŸ’¬ ì±„íŒ…ë°© ëª©ë¡</h3><p class="desc">íƒë°°ë³„ ê³ ê°ê³¼ ëŒ€í™”</p></div>`+
        keys.map(k=>{
            const w=wb[k],msgs=chatData[k]||{},mKeys=Object.keys(msgs).sort(),last=mKeys.length?msgs[mKeys[mKeys.length-1]]:null;
            const unread=mKeys.filter(mk=>msgs[mk].role==='customer'&&msgs[mk].time>(parseInt(localStorage.getItem('lastRead_s_'+k))||0)).length;
            return `<div class="chatroom-item" onclick="openStaffChat('${k}')"><div class="cr-left"><div class="cr-name">ğŸ“¦ ${k} â€” ${w.item}</div><div class="cr-preview">${last?((last.role==='staff'?'ë‚˜: ':'')+last.text):'ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”'}</div></div>${unread?`<span class="cr-badge">${unread}</span>`:''}</div>`;
        }).join('');
}
function openStaffChat(num){
    openChatRoom=num;localStorage.setItem('lastRead_s_'+num,Date.now());
    const el=document.getElementById('sChatArea');
    el.innerHTML=`<div class="card fade">
        <div class="d-head"><h3>ğŸ’¬ ${num}</h3><button class="btn-sm" onclick="renderStaffChatList();openChatRoom='';">â† ëª©ë¡</button></div>
        <div class="chat-box" id="chatBox_s_${num}" style="max-height:400px"></div>
        <div class="chat-input-row"><input type="text" id="chatIn_s_${num}" placeholder="ë©”ì‹œì§€..." maxlength="100" onkeypress="if(event.key==='Enter')sendMsg('${num}','staff')"><button class="btn btn-primary" onclick="sendMsg('${num}','staff')" style="padding:10px 16px;font-size:13px">ì „ì†¡</button></div>
    </div>`;
    loadChatRoom('s_',num);
}

// ê³ ê° ì±„íŒ… íƒ­
function renderCustChatList(){
    const el=document.getElementById('cChatArea');const keys=Object.keys(wb);
    if(!keys.length){el.innerHTML='<div class="search-card"><h3>ğŸ’¬ ì±„íŒ…</h3><p>íƒë°°ê°€ ì—†ì–´ìš”</p></div>';return;}
    el.innerHTML=`<div class="search-card fade"><h2>ğŸ’¬ ì±„íŒ…ë°©</h2><p>íƒë°°ì›ê³¼ ì‹¤ì‹œê°„ ëŒ€í™”</p></div>`+
        keys.map(k=>{
            const w=wb[k],msgs=chatData[k]||{},mKeys=Object.keys(msgs).sort(),last=mKeys.length?msgs[mKeys[mKeys.length-1]]:null;
            const unread=mKeys.filter(mk=>msgs[mk].role==='staff'&&msgs[mk].time>(parseInt(localStorage.getItem('lastRead_c_'+k))||0)).length;
            return `<div class="chatroom-item" onclick="openCustChat('${k}')"><div class="cr-left"><div class="cr-name">ğŸ“¦ ${k} â€” ${w.item}</div><div class="cr-preview">${last?((last.role==='customer'?'ë‚˜: ':'')+last.text):'ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”'}</div></div>${unread?`<span class="cr-badge">${unread}</span>`:''}</div>`;
        }).join('');
}
function openCustChat(num){
    openChatRoom=num;localStorage.setItem('lastRead_c_'+num,Date.now());
    const el=document.getElementById('cChatArea');
    el.innerHTML=`<div class="search-card fade">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="font-size:16px">ğŸ’¬ ${num}</h3><button class="btn-sm" onclick="renderCustChatList();openChatRoom='';">â† ëª©ë¡</button></div>
        <div class="chat-box" id="chatBox_c_${num}" style="max-height:400px;text-align:left"></div>
        <div class="chat-input-row"><input type="text" id="chatIn_c_${num}" placeholder="ë©”ì‹œì§€..." maxlength="100" onkeypress="if(event.key==='Enter')sendMsg('${num}','customer')"><button class="btn btn-primary" onclick="sendMsg('${num}','customer')" style="padding:10px 16px;font-size:13px">ì „ì†¡</button></div>
    </div>`;
    loadChatRoom('c_',num);
}

// ëŒ€ì‹œë³´ë“œ + ê·¸ë˜í”„
function renderDashboard(){
    const keys=Object.keys(wb),tot=keys.length,comp=keys.filter(k=>wb[k].cs>=6).length,ing=tot-comp;
    let avg=0,cnt=0;keys.forEach(k=>{const w=wb[k];if(w.cs>=6&&w.startTime&&w.completedAt){avg+=(w.completedAt-w.startTime);cnt++;}});
    const avgS=cnt?Math.round(avg/cnt/1000)+'ì´ˆ':'-',rate=tot?Math.round(comp/tot*100):0;
    // íƒë°°ì‚¬ë³„ ë°ì´í„°
    const carriers={};keys.forEach(k=>{const c=wb[k].cr;if(!carriers[c])carriers[c]={t:0,d:0};carriers[c].t++;if(wb[k].cs>=6)carriers[c].d++;});
    const cEntries=Object.entries(carriers);
    const maxT=Math.max(...cEntries.map(([,v])=>v.t),1);
    // ìƒíƒœë³„ ê·¸ë˜í”„
    const stCounts=Array(7).fill(0);keys.forEach(k=>stCounts[wb[k].cs]++);
    const maxSt=Math.max(...stCounts,1);

    document.getElementById('dashArea').innerHTML=`
        <div class="card fade"><h3>ğŸ“Š ë°°ì†¡ ëŒ€ì‹œë³´ë“œ</h3><p class="desc">ì‹¤ì‹œê°„ í˜„í™©</p>
            <div class="dash-grid"><div class="dash-card"><div class="dv">${tot}</div><div class="dl">ì „ì²´</div></div><div class="dash-card green"><div class="dv">${comp}</div><div class="dl">ì™„ë£Œ</div></div><div class="dash-card gold"><div class="dv">${ing}</div><div class="dl">ë°°ì†¡ì¤‘</div></div><div class="dash-card pink"><div class="dv">${rate}%</div><div class="dl">ì™„ë£Œìœ¨</div></div></div>
            <div class="info-grid"><div class="ig"><label>í‰ê·  ë°°ì†¡</label><span>${avgS}</span></div><div class="ig"><label>ê²½í—˜ì¹˜</label><span>${myExp} EXP</span></div><div class="ig"><label>ì´ ì™„ë£Œ</label><span>${myDeliveries}ê±´</span></div><div class="ig"><label>ì½”ì¸</label><span>ğŸ’°${myCoins}</span></div></div>
            <div class="exp-bar-wrap"><div class="exp-bar-fill" style="width:${getExpPct()}%"></div></div>
        </div>
        <div class="card"><h3>ğŸ“ˆ íƒë°°ì‚¬ë³„ í˜„í™©</h3>
            <div class="graph-section">${cEntries.map(([c,v],i)=>`<div class="graph-row"><div class="graph-label">${c}</div><div class="graph-bar-bg"><div class="graph-bar-fill ${GRAPH_COLORS[i%GRAPH_COLORS.length]}" style="width:${(v.t/maxT*100)}%">${v.d}/${v.t}</div></div></div>`).join('')}</div>
        </div>
        <div class="card"><h3>ğŸ“Š ë°°ì†¡ ë‹¨ê³„ë³„ í˜„í™©</h3>
            <div class="graph-section">${ST.map((s,i)=>`<div class="graph-row"><div class="graph-label">${s.i} ${s.n}</div><div class="graph-bar-bg"><div class="graph-bar-fill ${GRAPH_COLORS[i%GRAPH_COLORS.length]}" style="width:${(stCounts[i]/maxSt*100)}%">${stCounts[i]}ê±´</div></div></div>`).join('')}</div>
        </div>`;
}

function renderRankings(){rankRef.once('value',snap=>{const d=snap.val()||{},arr=Object.values(d).sort((a,b)=>b.deliveries-a.deliveries);document.getElementById('rankArea').innerHTML=`<div class="card fade"><h3>ğŸ† ë­í‚¹</h3><div style="margin-top:16px">${arr.length?arr.map((u,i)=>`<div class="rank-item"><div class="rank-num ${i===0?'g':i===1?'s':i===2?'b':''}">${i<3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]:(i+1)}</div><div><div style="font-weight:700;font-size:14px">${u.name}</div><div style="font-size:12px;color:#999">Lv.${u.level} Â· ${u.carrier||''} Â· ${u.deliveries}ê±´ Â· ${u.exp}EXP</div></div></div>`).join(''):'<p style="text-align:center;color:#aaa;padding:20px">ë°ì´í„° ì—†ìŒ</p>'}</div></div>`;});}

function renderShop(){document.getElementById('shopArea').innerHTML=`<div class="card fade"><h3>ğŸ›’ ìƒì </h3><p class="desc">ğŸ’°${myCoins} ì½”ì¸</p><div class="shop-grid">${SHOP_ITEMS.map(it=>{const ow=ownedSkins.includes(it.icon),eq=equippedSkin===it.icon;return `<div class="shop-item ${ow?'owned':''} ${eq?'equipped':''}" onclick="buyEquip('${it.icon}',${it.price})"><div class="si">${it.icon}</div><div class="sn">${it.name}</div><div class="sp">${eq?'âœ… ì¥ì°©':ow?'ë³´ìœ ':'ğŸ’°'+it.price}</div></div>`;}).join('')}</div></div>`;}
function buyEquip(ic,pr){if(ownedSkins.includes(ic)){equippedSkin=ic;toast(ic+' ì¥ì°©!');playSound('click');}else{if(myCoins<pr){toast('ğŸ’° ë¶€ì¡±!');playSound('alert');return;}myCoins-=pr;ownedSkins.push(ic);equippedSkin=ic;toast(ic+' êµ¬ë§¤!');playSound('success');confetti();vibrate(100);}saveUserData();updateTopBar();renderShop();renderList();}

// ê³ ê°
function renderCustomerList(){
    const el=document.getElementById('cListArea');if(!el)return;let keys=Object.keys(wb);
    if(!keys.length){el.innerHTML='<div class="result-card" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:8px">ğŸ“­</div><p style="color:#aaa">íƒë°°ê°€ ì—†ì–´ìš”</p></div>';return;}
    keys=filterSort(keys,custFilter,custSort);
    if(!keys.length){el.innerHTML='<div class="result-card" style="text-align:center;padding:30px"><p style="color:#aaa">ì¡°ê±´ì— ë§ëŠ” íƒë°° ì—†ìŒ</p></div>';return;}
    el.innerHTML=`<div class="c-list-title"><span class="online-dot"></span> ì „ì²´ íƒë°° (${keys.length}ê±´)</div>`+
        keys.map(k=>{const w=wb[k],s=w.cs,ti=ITEM_TYPES.find(t=>t.type===w.itemType)||ITEM_TYPES[0];const isNew=(Date.now()-(w.startTime||0))<30000;return `<div class="c-wb-card" onclick="trackDirect('${k}')"><div class="num">ğŸ“¦ ${k} ${ti.tag}${isNew?'<span class="new-badge">NEW</span>':''}</div><div class="meta">${w.item} Â· ${w.cr} Â· ${w.to}ë‹˜</div><span class="st s${s}">${ST[s].i} ${ST[s].n}</span></div>`;}).join('');
}

function trackDirect(num){document.getElementById('tInput').value=num;customerTrackingNum=num;cTab(1);const w=wb[num];if(!w)return;playSound('click');saveRecent(num);renderTracking(num,w,document.getElementById('tResult'));document.getElementById('tResult').scrollIntoView({behavior:'smooth',block:'start'});}

function track(){
    const inp=document.getElementById('tInput'),q=inp.value.trim().toLowerCase(),rd=document.getElementById('tResult');
    if(!q){inp.style.borderColor='#ff4757';setTimeout(()=>inp.style.borderColor='#e8e8e8',800);return;}
    playSound('click');
    // ê²€ìƒ‰: ë²ˆí˜¸, ë¬¼í’ˆëª…, ë°›ëŠ”ì‚¬ëŒ
    if(wb[q]){customerTrackingNum=q;saveRecent(q);renderTracking(q,wb[q],rd);return;}
    const found=Object.keys(wb).filter(k=>{const w=wb[k];return k.toLowerCase().includes(q)||w.item.toLowerCase().includes(q)||w.to.toLowerCase().includes(q);});
    if(found.length===1){customerTrackingNum=found[0];saveRecent(found[0]);renderTracking(found[0],wb[found[0]],rd);}
    else if(found.length>1){rd.innerHTML=`<div class="result-card fade"><p style="font-weight:700;margin-bottom:10px">ğŸ” ${found.length}ê±´ ê²€ìƒ‰ë¨</p>${found.map(k=>{const w=wb[k];return `<div class="c-wb-card" onclick="trackDirect('${k}')" style="margin-bottom:8px"><div class="num">ğŸ“¦ ${k}</div><div class="meta">${w.item} Â· ${w.to}ë‹˜</div><span class="st s${w.cs}">${ST[w.cs].i} ${ST[w.cs].n}</span></div>`;}).join('')}</div>`;}
    else{rd.innerHTML=`<div class="result-card fade"><div class="no-res"><div class="ni">ğŸ”</div><p>"${q}" ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p></div></div>`;customerTrackingNum='';}
}

function renderTracking(num,w,rd){
    if(!rd)return;const ti=ITEM_TYPES.find(t=>t.type===w.itemType)||ITEM_TYPES[0];
    let sh='';for(let i=0;i<ST.length;i++){const s=ST[i];let dc='',cc='',tm='';if(i<w.cs){dc='done';cc='done';tm=w.times[i]||'';}else if(i===w.cs){dc='now';tm=w.times[i]||'';}sh+=`<div class="step"><div class="sl"><div class="dot ${dc}">${i<w.cs?'âœ“':s.i}</div>${i<ST.length-1?`<div class="conn ${cc}"></div>`:''}</div><div class="sc"><div class="t">${s.n}</div>${tm?`<div class="tm">${tm}</div>`:''}${i<=w.cs?`<div class="ds">${s.d}</div>`:''}</div></div>`;}
    let map=w.fromCity&&w.toCity?renderMap(w.fromCity,w.toCity,w.cs):'';
    // ë©”ëª¨
    let memoHtml='';
    if(w.memo)memoHtml=`<div class="memo-box"><label>ğŸ“ ë‚´ ìš”ì²­ì‚¬í•­</label><p>${w.memo}</p></div>`;
    if(!w.memo&&w.cs<6)memoHtml=`<div style="margin-bottom:14px"><p style="font-size:13px;font-weight:700;margin-bottom:6px">ğŸ“ ë°°ì†¡ ìš”ì²­ì‚¬í•­</p><div class="row"><input type="text" id="memoIn_${num}" placeholder="ì˜ˆ: ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”" maxlength="50"><button class="btn btn-primary" onclick="saveMemo('${num}')" style="padding:12px 16px;font-size:13px">ì €ì¥</button></div></div>`;
    // ë³„ì 
    let rat='';
    if(w.cs>=6){if(!w.rating){rat=`<div style="margin-top:14px;text-align:center;padding:16px;background:#f8f9fa;border-radius:14px"><p style="font-weight:700;margin-bottom:8px">ë°°ì†¡ ì–´ë– ì…¨ë‚˜ìš”?</p><div class="star-row">${[1,2,3,4,5].map(s=>`<span class="star" onclick="setRate(${s})" id="star${s}">â­</span>`).join('')}</div><textarea id="revIn" placeholder="í•œì¤„ ë¦¬ë·°..." rows="2" style="margin-top:8px;font-size:13px;resize:none"></textarea><button class="btn btn-primary" onclick="submitRev('${num}')" style="margin-top:8px;width:100%">ì™„ë£Œ</button></div>`;}else{rat=`<div style="margin-top:14px;text-align:center;padding:16px;background:#f8f9fa;border-radius:14px"><p style="font-weight:700">ë‚´ í‰ê°€</p><div style="font-size:24px;margin:6px 0">${'â­'.repeat(w.rating)}${'â˜†'.repeat(5-w.rating)}</div>${w.review?`<p style="font-size:13px;color:#666">"${w.review}"</p>`:''}</div>`;}}
    // ì±„íŒ…
    let chat=`<div style="margin-top:14px"><p style="font-size:14px;font-weight:700;margin-bottom:8px">ğŸ’¬ íƒë°°ì›ê³¼ ì†Œí†µ</p><div class="chat-box" id="chatBox_c_${num}"></div><div class="chat-input-row"><input type="text" id="chatIn_c_${num}" placeholder="ë©”ì‹œì§€..." maxlength="100" onkeypress="if(event.key==='Enter')sendMsg('${num}','customer')"><button class="btn btn-primary" onclick="sendMsg('${num}','customer')" style="padding:10px 16px;font-size:13px">ì „ì†¡</button></div></div>`;
    rd.innerHTML=`<div class="result-card fade">
        <div class="r-head"><h3>ğŸ“¦ ${num} ${ti.tag}</h3><span class="cur-st s${w.cs}">${ST[w.cs].i} ${ST[w.cs].n}</span></div>
        <div style="background:#f0f7ff;padding:8px 14px;border-radius:10px;margin-bottom:14px;font-size:12px;color:#667eea;font-weight:600;text-align:center"><span class="online-dot"></span> ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸</div>
        ${map}${memoHtml}
        <div class="info-grid" style="margin-bottom:18px">
            <div class="ig"><label>ë¬¼í’ˆëª…</label><span>${w.item}</span></div><div class="ig"><label>íƒë°°ì‚¬</label><span>${w.cr}</span></div>
            <div class="ig"><label>ë³´ë‚´ëŠ” ë¶„</label><span>${w.from}</span></div><div class="ig"><label>ë°›ëŠ” ë¶„</label><span>${w.to}</span></div>
            <div class="ig full"><label>ë°›ëŠ” ì£¼ì†Œ</label><span>${w.ta}</span></div><div class="ig"><label>ì ‘ìˆ˜</label><span>${w.date}</span></div>
        </div>
        <div class="steps-title">ğŸ“ ë°°ì†¡ ì¶”ì </div>${sh}
        ${w.cs>=6?'<div class="done-badge">ğŸ‰ ë°°ì†¡ ì™„ë£Œ!</div>':''}
        ${rat}${chat}
    </div>`;
    loadChatRoom('c_',num);
}

function saveMemo(num){const inp=document.getElementById('memoIn_'+num);if(!inp)return;const t=inp.value.trim();if(!t){toast('ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');return;}wbRef.child(num).update({memo:t}).then(()=>{toast('ğŸ“ ìš”ì²­ì‚¬í•­ ì €ì¥!');playSound('success');});}

let curRate=0;
function setRate(n){curRate=n;for(let i=1;i<=5;i++){const e=document.getElementById('star'+i);if(e)e.classList.toggle('on',i<=n);}playSound('click');}
function submitRev(num){if(!curRate){toast('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”');return;}const rev=document.getElementById('revIn')?.value.trim()||'';wbRef.child(num).update({rating:curRate,review:rev}).then(()=>{toast('â­ í‰ê°€ ì™„ë£Œ!');playSound('success');confetti();curRate=0;});}

function saveRecent(num){let r=JSON.parse(localStorage.getItem('recent')||'[]');r=r.filter(n=>n!==num);r.unshift(num);if(r.length>8)r=r.slice(0,8);localStorage.setItem('recent',JSON.stringify(r));loadRecentSearches();}
function loadRecentSearches(){const r=JSON.parse(localStorage.getItem('recent')||'[]'),w=document.getElementById('recentWrap');if(!w)return;if(!r.length){w.innerHTML='';return;}w.innerHTML=`<div class="recent-list"><p style="font-size:12px;color:#aaa;margin-bottom:6px;font-weight:600">ìµœê·¼ ì¡°íšŒ</p>${r.map(n=>`<span class="recent-item" onclick="document.getElementById('tInput').value='${n}';track()">${n}</span>`).join('')}</div>`;}

if(localStorage.getItem('darkMode')==='true')document.body.classList.add('dark');
</script>
</body>
</html>
